"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const AWS = require("aws-sdk");
const SDKMock = require("aws-sdk-mock");
const uuid = require("uuid");
const lib_1 = require("../../lib");
const aws_auth_1 = require("../../lib/api/aws-auth");
const logging = require("../../lib/logging");
const bockfs = require("../bockfs");
// Mock promptly prompt to test MFA support
jest.mock('promptly', () => ({
    prompt: jest.fn().mockRejectedValue(new Error('test')),
}));
SDKMock.setSDKInstance(AWS);
const defaultCredOptions = {
    ec2creds: false,
    containerCreds: false,
};
// Account cache buster
let uid;
let pluginQueried = false;
let defaultEnv;
beforeEach(() => {
    uid = `(${uuid.v4()})`;
    logging.setLogLevel(2 /* TRACE */);
    SDKMock.mock('STS', 'getCallerIdentity', (cb) => {
        return cb(null, {
            Account: `${uid}the_account_#`,
            UserId: 'you!',
            Arn: 'arn:aws-here:iam::12345:role/test',
        });
    });
    lib_1.PluginHost.instance.credentialProviderSources.splice(0);
    lib_1.PluginHost.instance.credentialProviderSources.push({
        isAvailable() { return Promise.resolve(true); },
        canProvideCredentials(account) { return Promise.resolve(account === `${uid}plugin_account_#`); },
        getProvider() {
            pluginQueried = true;
            return Promise.resolve(new AWS.Credentials({
                accessKeyId: `${uid}plugin_key`,
                secretAccessKey: 'plugin_secret',
                sessionToken: 'plugin_token',
            }));
        },
        name: 'test plugin',
    });
    defaultEnv = cxapi.EnvironmentUtils.make(`${uid}the_account_#`, 'def');
    // Scrub some environment variables that might be set if we're running on CodeBuild which will interfere with the tests.
    delete process.env.AWS_PROFILE;
    delete process.env.AWS_REGION;
    delete process.env.AWS_DEFAULT_REGION;
    delete process.env.AWS_ACCESS_KEY_ID;
    delete process.env.AWS_SECRET_ACCESS_KEY;
    delete process.env.AWS_SESSION_TOKEN;
});
afterEach(() => {
    logging.setLogLevel(0 /* DEFAULT */);
    SDKMock.restore();
    bockfs.restore();
});
describe('with default config files', () => {
    beforeEach(() => {
        bockfs({
            '/home/me/.bxt/credentials': dedent(`
        [default]
        aws_access_key_id=${uid}access
        aws_secret_access_key=secret

        [foo]
        aws_access_key_id=${uid}fooccess
        aws_secret_access_key=secret

        [assumer]
        aws_access_key_id=${uid}assumer
        aws_secret_access_key=secret

        [mfa]
        aws_access_key_id=${uid}mfaccess
        aws_secret_access_key=secret
      `),
            '/home/me/.bxt/config': dedent(`
        [default]
        region=eu-bla-5

        [profile foo]
        region=eu-west-1

        [profile boo]
        aws_access_key_id=${uid}booccess
        aws_secret_access_key=boocret
        # No region here

        [profile assumable]
        role_arn=arn:aws:iam::12356789012:role/Assumable
        source_profile=assumer

        [profile assumer]
        region=us-east-2

        [profile mfa]
        region=eu-west-1

        [profile mfa-role]
        source_profile=mfa
        role_arn=arn:aws:iam::account:role/role
        mfa_serial=arn:aws:iam::account:mfa/user
      `),
        });
        // Set environment variables that we want
        process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
        process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    });
    describe('CLI compatible credentials loading', () => {
        test('default config credentials', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            // THEN
            expect(provider.defaultRegion).toEqual('eu-bla-5');
            await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
            const sdk = await provider.forEnvironment({ ...defaultEnv, region: 'rgn' }, aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
            expect(sdkConfig(sdk).region).toEqual('rgn');
        });
        test('unknown account and region uses current', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            // THEN
            const sdk = await provider.forEnvironment(cxapi.EnvironmentUtils.make(cxapi.UNKNOWN_ACCOUNT, cxapi.UNKNOWN_REGION), aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
            expect(sdkConfig(sdk).region).toEqual('eu-bla-5');
        });
        test('mixed profile credentials', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'foo' });
            // THEN
            expect(provider.defaultRegion).toEqual('eu-west-1');
            await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
            const sdk = await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}fooccess`);
        });
        test('pure config credentials', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
            // THEN
            expect(provider.defaultRegion).toEqual('eu-bla-5'); // Fall back to default config
            await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
            const sdk = await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
            expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}booccess`);
        });
        test('mfa_serial in profile will ask user for token', async () => {
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'mfa-role' });
            // THEN
            try {
                await provider.withAssumedRole('arn:aws:iam::account:role/role', undefined, undefined);
            }
            catch (e) {
                // Mock response was set to fail with message test to make sure we don't call STS
                expect(e.message).toEqual('Error fetching MFA token: test');
            }
        });
        test('different account throws', async () => {
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
            await expect(provider.forEnvironment({ ...defaultEnv, account: `${uid}some_account_#` }, aws_auth_1.Mode.ForReading)).rejects.toThrow('Need to perform AWS calls');
        });
        test('even when using a profile to assume another profile, STS calls goes through the proxy', async () => {
            // Messy mocking
            let called = false;
            jest.mock('proxy-agent', () => {
                // eslint-disable-next-line @typescript-eslint/no-require-imports
                class FakeAgent extends require('https').Agent {
                    addRequest(_, __) {
                        // FIXME: this error takes 6 seconds to be completely handled. It
                        // might be retries in the SDK somewhere, or something about the Node
                        // event loop. I've spent an hour trying to figure it out and I can't,
                        // and I gave up. We'll just have to live with this until someone gets
                        // inspired.
                        const error = new Error('ABORTED BY TEST');
                        error.code = 'RequestAbortedError';
                        error.retryable = false;
                        called = true;
                        throw error;
                    }
                }
                return FakeAgent;
            });
            // WHEN
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
                ...defaultCredOptions,
                profile: 'assumable',
                httpOptions: {
                    proxyAddress: 'http://DOESNTMATTER/',
                },
            });
            await provider.defaultAccount();
            // THEN -- the fake proxy agent got called, we don't care about the result
            expect(called).toEqual(true);
        });
        test('error we get from assuming a role is useful', async () => {
            // GIVEN
            // Because of the way ChainableTemporaryCredentials gets its STS client, it's not mockable
            // using 'mock-aws-sdk'. So instead, we have to mess around with its internals.
            function makeAssumeRoleFail(s) {
                s.credentials.service.assumeRole = jest.fn().mockImplementation((_request, cb) => {
                    cb(new Error('Nope!'));
                });
            }
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
                ...defaultCredOptions,
                httpOptions: {
                    proxyAddress: 'http://localhost:8080/',
                },
            });
            // WHEN
            const sdk = await provider.withAssumedRole('bla.role.arn', undefined, undefined);
            makeAssumeRoleFail(sdk);
            // THEN - error message contains both a helpful hint and the underlying AssumeRole message
            await expect(sdk.s3().listBuckets().promise()).rejects.toThrow('did you bootstrap');
            await expect(sdk.s3().listBuckets().promise()).rejects.toThrow('Nope!');
        });
    });
    describe('Plugins', () => {
        test('does not use plugins if current credentials are for expected account', async () => {
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
            expect(pluginQueried).toEqual(false);
        });
        test('uses plugin for other account', async () => {
            const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
            await provider.forEnvironment({ ...defaultEnv, account: `${uid}plugin_account_#` }, aws_auth_1.Mode.ForReading);
            expect(pluginQueried).toEqual(true);
        });
    });
});
test('can assume role without a [default] profile', async () => {
    // GIVEN
    bockfs({
        '/home/me/.bxt/credentials': dedent(`
      [assumer]
      aws_access_key_id=${uid}assumer
      aws_secret_access_key=secret

      [assumable]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      source_profile=assumer
    `),
        '/home/me/.bxt/config': dedent(`
      [profile assumable]
      region=eu-bla-5
    `),
    });
    SDKMock.mock('STS', 'assumeRole', (_request, cb) => {
        return cb(null, {
            Credentials: {
                AccessKeyId: `${uid}access`,
                Expiration: new Date(Date.now() + 10000),
                SecretAccessKey: 'b',
                SessionToken: 'c',
            },
        });
    });
    // Set environment variables that we want
    process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
    process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    // WHEN
    const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
        ...defaultCredOptions,
        profile: 'assumable',
        httpOptions: {
            proxyAddress: 'http://DOESNTMATTER/',
        },
    });
    const account = await provider.defaultAccount();
    // THEN
    expect(account === null || account === void 0 ? void 0 : account.accountId).toEqual(`${uid}the_account_#`);
});
/**
 * Strip shared whitespace from the start of lines
 */
function dedent(x) {
    const lines = x.split('\n');
    while (lines.length > 0 && lines[0].trim() === '') {
        lines.shift();
    }
    while (lines.length > 0 && lines[lines.length - 1].trim() === '') {
        lines.pop();
    }
    const wsRe = /^\s*/;
    const lineParts = x.split('\n').map(s => {
        const ws = wsRe.exec(s)[0];
        return [ws, s.substr(ws.length)];
    });
    if (lineParts.length === 0) {
        return '';
    } // Reduce won't work well in this case
    // Calculate common whitespace only for non-empty lines
    const sharedWs = lineParts.reduce((commonWs, [ws, text]) => text !== '' ? commonPrefix(commonWs, ws) : commonWs, lineParts[0][0]);
    return lines.map(s => s.substr(sharedWs.length)).join('\n');
}
/**
 * Use object hackery to get the credentials out of the SDK object
 */
function sdkConfig(sdk) {
    return sdk.config;
}
function commonPrefix(a, b) {
    const N = Math.min(a.length, b.length);
    for (let i = 0; i < N; i++) {
        if (a[i] !== b[i]) {
            return a.substring(0, i);
        }
    }
    return a.substr(N);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RrLXByb3ZpZGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZGstcHJvdmlkZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QywrQkFBK0I7QUFDL0Isd0NBQXdDO0FBRXhDLDZCQUE2QjtBQUM3QixtQ0FBdUM7QUFDdkMscURBQWlFO0FBQ2pFLDZDQUE2QztBQUM3QyxvQ0FBb0M7QUFFcEMsMkNBQTJDO0FBQzNDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDM0IsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztDQUN2RCxDQUFDLENBQUMsQ0FBQztBQUVKLE9BQU8sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7QUFJNUIsTUFBTSxrQkFBa0IsR0FBRztJQUN6QixRQUFRLEVBQUUsS0FBSztJQUNmLGNBQWMsRUFBRSxLQUFLO0NBQ3RCLENBQUM7QUFFRix1QkFBdUI7QUFDdkIsSUFBSSxHQUFXLENBQUM7QUFDaEIsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDO0FBQzFCLElBQUksVUFBNkIsQ0FBQztBQUVsQyxVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUM7SUFFdkIsT0FBTyxDQUFDLFdBQVcsZUFBd0IsQ0FBQztJQUU1QyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxDQUFDLEVBQWtELEVBQUUsRUFBRTtRQUM5RixPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUU7WUFDZCxPQUFPLEVBQUUsR0FBRyxHQUFHLGVBQWU7WUFDOUIsTUFBTSxFQUFFLE1BQU07WUFDZCxHQUFHLEVBQUUsbUNBQW1DO1NBQ3pDLENBQUMsQ0FBQztJQUNMLENB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O0FBRUQsU0FBUyxZQUFZLENBQUMsQ0FBUyxFQUFFLENBQVM7SUFDeEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQzFCLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUFFLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FBRTtLQUNqRDtJQUNELE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNyQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY3hhcGkgZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCAqIGFzIFNES01vY2sgZnJvbSAnYXdzLXNkay1tb2NrJztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25PcHRpb25zIH0gZnJvbSAnYXdzLXNkay9saWIvY29uZmlnJztcbmltcG9ydCAqIGFzIHV1aWQgZnJvbSAndXVpZCc7XG5pbXBvcnQgeyBQbHVnaW5Ib3N0IH0gZnJvbSAnLi4vLi4vbGliJztcbmltcG9ydCB7IElTREssIE1vZGUsIFNka1Byb3ZpZGVyIH0gZnJvbSAnLi4vLi4vbGliL2FwaS9hd3MtYXV0aCc7XG5pbXBvcnQgKiBhcyBsb2dnaW5nIGZyb20gJy4uLy4uL2xpYi9sb2dnaW5nJztcbmltcG9ydCAqIGFzIGJvY2tmcyBmcm9tICcuLi9ib2NrZnMnO1xuXG4vLyBNb2NrIHByb21wdGx5IHByb21wdCB0byB0ZXN0IE1GQSBzdXBwb3J0XG5qZXN0Lm1vY2soJ3Byb21wdGx5JywgKCkgPT4gKHtcbiAgcHJvbXB0OiBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCd0ZXN0JykpLFxufSkpO1xuXG5TREtNb2NrLnNldFNES0luc3RhbmNlKEFXUyk7XG5cbnR5cGUgQXdzQ2FsbGJhY2s8VD4gPSAoZXJyOiBFcnJvciB8IG51bGwsIHZhbDogVCkgPT4gdm9pZDtcblxuY29uc3QgZGVmYXVsdENyZWRPcHRpb25zID0ge1xuICBlYzJjcmVkczogZmFsc2UsXG4gIGNvbnRhaW5lckNyZWRzOiBmYWxzZSxcbn07XG5cbi8vIEFjY291bnQgY2FjaGUgYnVzdGVyXG5sZXQgdWlkOiBzdHJpbmc7XG5sZXQgcGx1Z2luUXVlcmllZCA9IGZhbHNlO1xubGV0IGRlZmF1bHRFbnY6IGN4YXBpLkVudmlyb25tZW50O1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgdWlkID0gYCgke3V1aWQudjQoKX0pYDtcblxuICBsb2dnaW5nLnNldExvZ0xldmVsKGxvZ2dpbmcuTG9nTGV2ZWwuVFJBQ0UpO1xuXG4gIFNES01vY2subW9jaygnU1RTJywgJ2dldENhbGxlcklkZW50aXR5JywgKGNiOiBBd3NDYWxsYmFjazxBV1MuU1RTLkdldENhbGxlcklkZW50aXR5UmVzcG9uc2U+KSA9PiB7XG4gICAgcmV0dXJuIGNiKG51bGwsIHtcbiAgICAgIEFjY291bnQ6IGAke3VpZH10aGVfYWNjb3VudF8jYCxcbiAgICAgIFVzZXJJZDogJ3lvdSEnLFxuICAgICAgQXJuOiAnYXJuOmF3cy1oZXJlOmlhbTo6MTIzNDU6cm9sZS90ZXN0JyxcbiAgICB9KTtcbiAgfSk7XG5cbiAgUGx1Z2luSG9zdC5pbnN0YW5jZS5jcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VzLnNwbGljZSgwKTtcbiAgUGx1Z2luSG9zdC5pbnN0YW5jZS5jcmVkZW50aWFsUHJvdmlkZXJTb3VyY2VzLnB1c2goe1xuICAgIGlzQXZhaWxhYmxlKCkgeyByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpOyB9LFxuICAgIGNhblByb3ZpZGVDcmVkZW50aWFscyhhY2NvdW50KSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUoYWNjb3VudCA9PT0gYCR7dWlkfXBsdWdpbl9hY2NvdW50XyNgKTsgfSxcbiAgICBnZXRQcm92aWRlcigpIHtcbiAgICAgIHBsdWdpblF1ZXJpZWQgPSB0cnVlO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQVdTLkNyZWRlbnRpYWxzKHtcbiAgICAgICAgYWNjZXNzS2V5SWQ6IGAke3VpZH1wbHVnaW5fa2V5YCxcbiAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiAncGx1Z2luX3NlY3JldCcsXG4gICAgICAgIHNlc3Npb25Ub2tlbjogJ3BsdWdpbl90b2tlbicsXG4gICAgICB9KSk7XG4gICAgfSxcbiAgICBuYW1lOiAndGVzdCBwbHVnaW4nLFxuICB9KTtcblxuICBkZWZhdWx0RW52ID0gY3hhcGkuRW52aXJvbm1lbnRVdGlscy5tYWtlKGAke3VpZH10aGVfYWNjb3VudF8jYCwgJ2RlZicpO1xuXG4gIC8vIFNjcnViIHNvbWUgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgbWlnaHQgYmUgc2V0IGlmIHdlJ3JlIHJ1bm5pbmcgb24gQ29kZUJ1aWxkIHdoaWNoIHdpbGwgaW50ZXJmZXJlIHdpdGggdGhlIHRlc3RzLlxuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEU7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfUkVHSU9OO1xuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX0RFRkFVTFRfUkVHSU9OO1xuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQ7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVk7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfU0VTU0lPTl9UT0tFTjtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBsb2dnaW5nLnNldExvZ0xldmVsKGxvZ2dpbmcuTG9nTGV2ZWwuREVGQVVMVCk7XG5cbiAgU0RLTW9jay5yZXN0b3JlKCk7XG4gIGJvY2tmcy5yZXN0b3JlKCk7XG59KTtcblxuZGVzY3JpYmUoJ3dpdGggZGVmYXVsdCBjb25maWcgZmlsZXMnLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGJvY2tmcyh7XG4gICAgICAnL2hvbWUvbWUvLmJ4dC9jcmVkZW50aWFscyc6IGRlZGVudChgXG4gICAgICAgIFtkZWZhdWx0XVxuICAgICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1hY2Nlc3NcbiAgICAgICAgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5PXNlY3JldFxuXG4gICAgICAgIFtmb29dXG4gICAgICAgIGF3c19hY2Nlc3Nfa2V5X2lkPSR7dWlkfWZvb2NjZXNzXG4gICAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1zZWNyZXRcblxuICAgICAgICBbYXNzdW1lcl1cbiAgICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9YXNzdW1lclxuICAgICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9c2VjcmV0XG5cbiAgICAgICAgW21mYV1cbiAgICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9bWZhY2Nlc3NcbiAgICAgICAgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5PXNlY3JldFxuICAgICAgYCksXG4gICAgICAnL2hvbWUvbWUvLmJ4dC9jb25maWcnOiBkZWRlbnQoYFxuICAgICAgICBbZGVmYXVsdF1cbiAgICAgICAgcmVnaW9uPWV1LWJsYS01XG5cbiAgICAgICAgW3Byb2ZpbGUgZm9vXVxuICAgICAgICByZWdpb249ZXUtd2VzdC0xXG5cbiAgICAgICAgW3Byb2ZpbGUgYm9vXVxuICAgICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1ib29jY2Vzc1xuICAgICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9Ym9vY3JldFxuICAgICAgICAjIE5vIHJlZ2lvbiBoZXJlXG5cbiAgICAgICAgW3Byb2ZpbGUgYXNzdW1hYmxlXVxuICAgICAgICByb2xlX2Fybj1hcm46YXdzOmlhbTo6MTIzNTY3ODkwMTI6cm9sZS9Bc3N1bWFibGVcbiAgICAgICAgc291cmNlX3Byb2ZpbGU9YXNzdW1lclxuXG4gICAgICAgIFtwcm9maWxlIGFzc3VtZXJdXG4gICAgICAgIHJlZ2lvbj11cy1lYXN0LTJcblxuICAgICAgICBbcHJvZmlsZSBtZmFdXG4gICAgICAgIHJlZ2lvbj1ldS13ZXN0LTFcblxuICAgICAgICBbcHJvZmlsZSBtZmEtcm9sZV1cbiAgICAgICAgc291cmNlX3Byb2ZpbGU9bWZhXG4gICAgICAgIHJvbGVfYXJuPWFybjphd3M6aWFtOjphY2NvdW50OnJvbGUvcm9sZVxuICAgICAgICBtZmFfc2VyaWFsPWFybjphd3M6aWFtOjphY2NvdW50Om1mYS91c2VyXG4gICAgICBgKSxcbiAgICB9KTtcblxuICAgIC8vIFNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCB3ZSB3YW50XG4gICAgcHJvY2Vzcy5lbnYuQVdTX0NPTkZJR19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY29uZmlnJyk7XG4gICAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NMSSBjb21wYXRpYmxlIGNyZWRlbnRpYWxzIGxvYWRpbmcnLCAoKSA9PiB7XG4gICAgdGVzdCgnZGVmYXVsdCBjb25maWcgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdChwcm92aWRlci5kZWZhdWx0UmVnaW9uKS50b0VxdWFsKCdldS1ibGEtNScpO1xuICAgICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBhY2NvdW50SWQ6IGAke3VpZH10aGVfYWNjb3VudF8jYCwgcGFydGl0aW9uOiAnYXdzLWhlcmUnIH0pO1xuICAgICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoeyAuLi5kZWZhdWx0RW52LCByZWdpb246ICdyZ24nIH0sIE1vZGUuRm9yUmVhZGluZyk7XG4gICAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1hY2Nlc3NgKTtcbiAgICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5yZWdpb24pLnRvRXF1YWwoJ3JnbicpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgndW5rbm93biBhY2NvdW50IGFuZCByZWdpb24gdXNlcyBjdXJyZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zIH0pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBjb25zdCBzZGsgPSBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudChjeGFwaS5FbnZpcm9ubWVudFV0aWxzLm1ha2UoY3hhcGkuVU5LTk9XTl9BQ0NPVU5ULCBjeGFwaS5VTktOT1dOX1JFR0lPTiksIE1vZGUuRm9yUmVhZGluZyk7XG4gICAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1hY2Nlc3NgKTtcbiAgICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5yZWdpb24pLnRvRXF1YWwoJ2V1LWJsYS01Jyk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdtaXhlZCBwcm9maWxlIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnZm9vJyB9KTtcblxuICAgICAgLy8gVEhFTlxuICAgICAgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRSZWdpb24pLnRvRXF1YWwoJ2V1LXdlc3QtMScpO1xuICAgICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBhY2NvdW50SWQ6IGAke3VpZH10aGVfYWNjb3VudF8jYCwgcGFydGl0aW9uOiAnYXdzLWhlcmUnIH0pO1xuICAgICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoZGVmYXVsdEVudiwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5jcmVkZW50aWFscyEuYWNjZXNzS2V5SWQpLnRvRXF1YWwoYCR7dWlkfWZvb2NjZXNzYCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KCdwdXJlIGNvbmZpZyBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucywgcHJvZmlsZTogJ2JvbycgfSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdChwcm92aWRlci5kZWZhdWx0UmVnaW9uKS50b0VxdWFsKCdldS1ibGEtNScpOyAvLyBGYWxsIGJhY2sgdG8gZGVmYXVsdCBjb25maWdcbiAgICAgIGF3YWl0IGV4cGVjdChwcm92aWRlci5kZWZhdWx0QWNjb3VudCgpKS5yZXNvbHZlcy50b0VxdWFsKHsgYWNjb3VudElkOiBgJHt1aWR9dGhlX2FjY291bnRfI2AsIHBhcnRpdGlvbjogJ2F3cy1oZXJlJyB9KTtcbiAgICAgIGNvbnN0IHNkayA9IGF3YWl0IHByb3ZpZGVyLmZvckVudmlyb25tZW50KGRlZmF1bHRFbnYsIE1vZGUuRm9yUmVhZGluZyk7XG4gICAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1ib29jY2Vzc2ApO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnbWZhX3NlcmlhbCBpbiBwcm9maWxlIHdpbGwgYXNrIHVzZXIgZm9yIHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV0hFTlxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnbWZhLXJvbGUnIH0pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBwcm92aWRlci53aXRoQXNzdW1lZFJvbGUoJ2Fybjphd3M6aWFtOjphY2NvdW50OnJvbGUvcm9sZScsIHVuZGVmaW5lZCwgdW5kZWZpbmVkKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gTW9jayByZXNwb25zZSB3YXMgc2V0IHRvIGZhaWwgd2l0aCBtZXNzYWdlIHRlc3QgdG8gbWFrZSBzdXJlIHdlIGRvbid0IGNhbGwgU1RTXG4gICAgICAgIGV4cGVjdChlLm1lc3NhZ2UpLnRvRXF1YWwoJ0Vycm9yIGZldGNoaW5nIE1GQSB0b2tlbjogdGVzdCcpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGVzdCgnZGlmZmVyZW50IGFjY291bnQgdGhyb3dzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnYm9vJyB9KTtcblxuICAgICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmZvckVudmlyb25tZW50KHsgLi4uZGVmYXVsdEVudiwgYWNjb3VudDogYCR7dWlkfXNvbWVfYWNjb3VudF8jYCB9LCBNb2RlLkZvclJlYWRpbmcpKS5yZWplY3RzLnRvVGhyb3coJ05lZWQgdG8gcGVyZm9ybSBBV1MgY2FsbHMnKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2V2ZW4gd2hlbiB1c2luZyBhIHByb2ZpbGUgdG8gYXNzdW1lIGFub3RoZXIgcHJvZmlsZSwgU1RTIGNhbGxzIGdvZXMgdGhyb3VnaCB0aGUgcHJveHknLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNZXNzeSBtb2NraW5nXG4gICAgICBsZXQgY2FsbGVkID0gZmFsc2U7XG4gICAgICBqZXN0Lm1vY2soJ3Byb3h5LWFnZW50JywgKCkgPT4ge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuICAgICAgICBjbGFzcyBGYWtlQWdlbnQgZXh0ZW5kcyByZXF1aXJlKCdodHRwcycpLkFnZW50IHtcbiAgICAgICAgICBwdWJsaWMgYWRkUmVxdWVzdChfOiBhbnksIF9fOiBhbnkpIHtcbiAgICAgICAgICAgIC8vIEZJWE1FOiB0aGlzIGVycm9yIHRha2VzIDYgc2Vjb25kcyB0byBiZSBjb21wbGV0ZWx5IGhhbmRsZWQuIEl0XG4gICAgICAgICAgICAvLyBtaWdodCBiZSByZXRyaWVzIGluIHRoZSBTREsgc29tZXdoZXJlLCBvciBzb21ldGhpbmcgYWJvdXQgdGhlIE5vZGVcbiAgICAgICAgICAgIC8vIGV2ZW50IGxvb3AuIEkndmUgc3BlbnQgYW4gaG91ciB0cnlpbmcgdG8gZmlndXJlIGl0IG91dCBhbmQgSSBjYW4ndCxcbiAgICAgICAgICAgIC8vIGFuZCBJIGdhdmUgdXAuIFdlJ2xsIGp1c3QgaGF2ZSB0byBsaXZlIHdpdGggdGhpcyB1bnRpbCBzb21lb25lIGdldHNcbiAgICAgICAgICAgIC8vIGluc3BpcmVkLlxuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ0FCT1JURUQgQlkgVEVTVCcpO1xuICAgICAgICAgICAgKGVycm9yIGFzIGFueSkuY29kZSA9ICdSZXF1ZXN0QWJvcnRlZEVycm9yJztcbiAgICAgICAgICAgIChlcnJvciBhcyBhbnkpLnJldHJ5YWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgY2FsbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gRmFrZUFnZW50O1xuICAgICAgfSk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7XG4gICAgICAgIC4uLmRlZmF1bHRDcmVkT3B0aW9ucyxcbiAgICAgICAgcHJvZmlsZTogJ2Fzc3VtYWJsZScsXG4gICAgICAgIGh0dHBPcHRpb25zOiB7XG4gICAgICAgICAgcHJveHlBZGRyZXNzOiAnaHR0cDovL0RPRVNOVE1BVFRFUi8nLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCk7XG5cbiAgICAgIC8vIFRIRU4gLS0gdGhlIGZha2UgcHJveHkgYWdlbnQgZ290IGNhbGxlZCwgd2UgZG9uJ3QgY2FyZSBhYm91dCB0aGUgcmVzdWx0XG4gICAgICBleHBlY3QoY2FsbGVkKS50b0VxdWFsKHRydWUpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnZXJyb3Igd2UgZ2V0IGZyb20gYXNzdW1pbmcgYSByb2xlIGlzIHVzZWZ1bCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEdJVkVOXG4gICAgICAvLyBCZWNhdXNlIG9mIHRoZSB3YXkgQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgZ2V0cyBpdHMgU1RTIGNsaWVudCwgaXQncyBub3QgbW9ja2FibGVcbiAgICAgIC8vIHVzaW5nICdtb2NrLWF3cy1zZGsnLiBTbyBpbnN0ZWFkLCB3ZSBoYXZlIHRvIG1lc3MgYXJvdW5kIHdpdGggaXRzIGludGVybmFscy5cbiAgICAgIGZ1bmN0aW9uIG1ha2VBc3N1bWVSb2xlRmFpbChzOiBJU0RLKSB7XG4gICAgICAgIChzIGFzIGFueSkuY3JlZGVudGlhbHMuc2VydmljZS5hc3N1bWVSb2xlID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoX3JlcXVlc3QsIGNiKSA9PiB7XG4gICAgICAgICAgY2IobmV3IEVycm9yKCdOb3BlIScpKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7XG4gICAgICAgIC4uLmRlZmF1bHRDcmVkT3B0aW9ucyxcbiAgICAgICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgICAgICBwcm94eUFkZHJlc3M6ICdodHRwOi8vbG9jYWxob3N0OjgwODAvJyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBXSEVOXG4gICAgICBjb25zdCBzZGsgPSBhd2FpdCBwcm92aWRlci53aXRoQXNzdW1lZFJvbGUoJ2JsYS5yb2xlLmFybicsIHVuZGVmaW5lZCwgdW5kZWZpbmVkKTtcbiAgICAgIG1ha2VBc3N1bWVSb2xlRmFpbChzZGspO1xuXG4gICAgICAvLyBUSEVOIC0gZXJyb3IgbWVzc2FnZSBjb250YWlucyBib3RoIGEgaGVscGZ1bCBoaW50IGFuZCB0aGUgdW5kZXJseWluZyBBc3N1bWVSb2xlIG1lc3NhZ2VcbiAgICAgIGF3YWl0IGV4cGVjdChzZGsuczMoKS5saXN0QnVja2V0cygpLnByb21pc2UoKSkucmVqZWN0cy50b1Rocm93KCdkaWQgeW91IGJvb3RzdHJhcCcpO1xuICAgICAgYXdhaXQgZXhwZWN0KHNkay5zMygpLmxpc3RCdWNrZXRzKCkucHJvbWlzZSgpKS5yZWplY3RzLnRvVGhyb3coJ05vcGUhJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdQbHVnaW5zJywgKCkgPT4ge1xuICAgIHRlc3QoJ2RvZXMgbm90IHVzZSBwbHVnaW5zIGlmIGN1cnJlbnQgY3JlZGVudGlhbHMgYXJlIGZvciBleHBlY3RlZCBhY2NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zIH0pO1xuICAgICAgYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoZGVmYXVsdEVudiwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICAgIGV4cGVjdChwbHVnaW5RdWVyaWVkKS50b0VxdWFsKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3VzZXMgcGx1Z2luIGZvciBvdGhlciBhY2NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zIH0pO1xuICAgICAgYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoeyAuLi5kZWZhdWx0RW52LCBhY2NvdW50OiBgJHt1aWR9cGx1Z2luX2FjY291bnRfI2AgfSwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICAgIGV4cGVjdChwbHVnaW5RdWVyaWVkKS50b0VxdWFsKHRydWUpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuXG50ZXN0KCdjYW4gYXNzdW1lIHJvbGUgd2l0aG91dCBhIFtkZWZhdWx0XSBwcm9maWxlJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBib2NrZnMoe1xuICAgICcvaG9tZS9tZS8uYnh0L2NyZWRlbnRpYWxzJzogZGVkZW50KGBcbiAgICAgIFthc3N1bWVyXVxuICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9YXNzdW1lclxuICAgICAgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5PXNlY3JldFxuXG4gICAgICBbYXNzdW1hYmxlXVxuICAgICAgcm9sZV9hcm49YXJuOmF3czppYW06OjEyMzU2Nzg5MDEyOnJvbGUvQXNzdW1hYmxlXG4gICAgICBzb3VyY2VfcHJvZmlsZT1hc3N1bWVyXG4gICAgYCksXG4gICAgJy9ob21lL21lLy5ieHQvY29uZmlnJzogZGVkZW50KGBcbiAgICAgIFtwcm9maWxlIGFzc3VtYWJsZV1cbiAgICAgIHJlZ2lvbj1ldS1ibGEtNVxuICAgIGApLFxuICB9KTtcblxuICBTREtNb2NrLm1vY2soJ1NUUycsICdhc3N1bWVSb2xlJywgKF9yZXF1ZXN0OiBBV1MuU1RTLkFzc3VtZVJvbGVSZXF1ZXN0LCBjYjogQXdzQ2FsbGJhY2s8QVdTLlNUUy5Bc3N1bWVSb2xlUmVzcG9uc2U+KSA9PiB7XG4gICAgcmV0dXJuIGNiKG51bGwsIHtcbiAgICAgIENyZWRlbnRpYWxzOiB7XG4gICAgICAgIEFjY2Vzc0tleUlkOiBgJHt1aWR9YWNjZXNzYCwgLy8gTmVlZHMgVUlEIGluIGhlcmUgb3RoZXJ3aXNlIGtleSB3aWxsIGJlIGNhY2hlZFxuICAgICAgICBFeHBpcmF0aW9uOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMTAwMDApLFxuICAgICAgICBTZWNyZXRBY2Nlc3NLZXk6ICdiJyxcbiAgICAgICAgU2Vzc2lvblRva2VuOiAnYycsXG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcblxuICAvLyBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2Ugd2FudFxuICBwcm9jZXNzLmVudi5BV1NfQ09ORklHX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jb25maWcnKTtcbiAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7XG4gICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgIHByb2ZpbGU6ICdhc3N1bWFibGUnLFxuICAgIGh0dHBPcHRpb25zOiB7XG4gICAgICBwcm94eUFkZHJlc3M6ICdodHRwOi8vRE9FU05UTUFUVEVSLycsXG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgYWNjb3VudCA9IGF3YWl0IHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoYWNjb3VudD8uYWNjb3VudElkKS50b0VxdWFsKGAke3VpZH10aGVfYWNjb3VudF8jYCk7XG59KTtcblxuLyoqXG4gKiBTdHJpcCBzaGFyZWQgd2hpdGVzcGFjZSBmcm9tIHRoZSBzdGFydCBvZiBsaW5lc1xuICovXG5mdW5jdGlvbiBkZWRlbnQoeDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbGluZXMgPSB4LnNwbGl0KCdcXG4nKTtcbiAgd2hpbGUgKGxpbmVzLmxlbmd0aCA+IDAgJiYgbGluZXNbMF0udHJpbSgpID09PSAnJykgeyBsaW5lcy5zaGlmdCgpOyB9XG4gIHdoaWxlIChsaW5lcy5sZW5ndGggPiAwICYmIGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLnRyaW0oKSA9PT0gJycpIHsgbGluZXMucG9wKCk7IH1cblxuICBjb25zdCB3c1JlID0gL15cXHMqLztcbiAgY29uc3QgbGluZVBhcnRzOiBBcnJheTxbc3RyaW5nLCBzdHJpbmddPiA9IHguc3BsaXQoJ1xcbicpLm1hcChzID0+IHtcbiAgICBjb25zdCB3cyA9IHdzUmUuZXhlYyhzKSFbMF07XG4gICAgcmV0dXJuIFt3cywgcy5zdWJzdHIod3MubGVuZ3RoKV07XG4gIH0pO1xuXG4gIGlmIChsaW5lUGFydHMubGVuZ3RoID09PSAwKSB7IHJldHVybiAnJzsgfSAvLyBSZWR1Y2Ugd29uJ3Qgd29yayB3ZWxsIGluIHRoaXMgY2FzZVxuXG4gIC8vIENhbGN1bGF0ZSBjb21tb24gd2hpdGVzcGFjZSBvbmx5IGZvciBub24tZW1wdHkgbGluZXNcbiAgY29uc3Qgc2hhcmVkV3MgPSBsaW5lUGFydHMucmVkdWNlKChjb21tb25Xczogc3RyaW5nLCBbd3MsIHRleHRdKSA9PiB0ZXh0ICE9PSAnJyA/IGNvbW1vblByZWZpeChjb21tb25Xcywgd3MpIDogY29tbW9uV3MsIGxpbmVQYXJ0c1swXVswXSk7XG4gIHJldHVybiBsaW5lcy5tYXAocyA9PiBzLnN1YnN0cihzaGFyZWRXcy5sZW5ndGgpKS5qb2luKCdcXG4nKTtcbn1cblxuLyoqXG4gKiBVc2Ugb2JqZWN0IGhhY2tlcnkgdG8gZ2V0IHRoZSBjcmVkZW50aWFscyBvdXQgb2YgdGhlIFNESyBvYmplY3RcbiAqL1xuZnVuY3Rpb24gc2RrQ29uZmlnKHNkazogSVNESyk6IENvbmZpZ3VyYXRpb25PcHRpb25zIHtcbiAgcmV0dXJuIChzZGsgYXMgYW55KS5jb25maWc7XG59XG5cbmZ1bmN0aW9uIGNvbW1vblByZWZpeChhOiBzdHJpbmcsIGI6IHN0cmluZyk6IHN0cmluZyB7XG4gIGNvbnN0IE4gPSBNYXRoLm1pbihhLmxlbmd0aCwgYi5sZW5ndGgpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkrKykge1xuICAgIGlmIChhW2ldICE9PSBiW2ldKSB7IHJldHVybiBhLnN1YnN0cmluZygwLCBpKTsgfVxuICB9XG4gIHJldHVybiBhLnN1YnN0cihOKTtcbn1cbiJdfQ==