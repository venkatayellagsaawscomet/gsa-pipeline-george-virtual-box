"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PatchedSharedIniFileCredentials = void 0;
const AWS = require("aws-sdk");
/**
 * Hack-fix
 *
 * There are a number of issues in the upstream version of SharedIniFileCredentials
 * that need fixing:
 *
 *  1. The upstream aws-sdk contains an incorrect instantiation of an `AWS.STS`
 *     client, which *should* have taken the region from the requested profile
 *     but doesn't. It will use the region from the default profile, which
 *     may not exist, defaulting to `us-east-1` (since we switched to
 *     AWS_STS_REGIONAL_ENDPOINTS=regional, that default is not even allowed anymore
 *     and the absence of a default region will lead to an error).
 *
 *  2. The simple fix is to get the region from the `config` file. profiles
 *     are made up of a combination of `credentials` and `config`, and the region is
 *     generally in `config` with the rest in `credentials`. However, a bug in
 *     `getProfilesFromSharedConfig` overwrites ALL `config` data with `credentials`
 *     data, so we also need to do extra work to fish the `region` out of the config.
 *
 * See https://github.com/aws/aws-sdk-js/issues/3418 for all the gory details.
 */
class PatchedSharedIniFileCredentials extends AWS.SharedIniFileCredentials {
    loadRoleProfile(creds, roleProfile, callback) {
        // Need to duplicate the whole implementation here -- the function is long and has been written in
        // such a way that there are no small monkey patches possible.
        var _a, _b, _c, _d;
        if (this.disableAssumeRole) {
            throw AWS.util.error(new Error('Role assumption profiles are disabled. ' +
                'Failed to load profile ' + this.profile +
                ' from ' + creds.filename), { code: 'SharedIniFileCredentialsProviderFailure' });
        }
        var self = this;
        var roleArn = roleProfile.role_arn;
        var roleSessionName = roleProfile.role_session_name;
        var externalId = roleProfile.external_id;
        var mfaSerial = roleProfile.mfa_serial;
        var sourceProfileName = roleProfile.source_profile;
        if (!sourceProfileName) {
            throw AWS.util.error(new Error('source_profile is not set using profile ' + this.profile), { code: 'SharedIniFileCredentialsProviderFailure' });
        }
        var sourceProfileExistanceTest = creds[sourceProfileName];
        if (typeof sourceProfileExistanceTest !== 'object') {
            throw AWS.util.error(new Error('source_profile ' + sourceProfileName + ' using profile '
                + this.profile + ' does not exist'), { code: 'SharedIniFileCredentialsProviderFailure' });
        }
        var sourceCredentials = new AWS.SharedIniFileCredentials(AWS.util.merge(this.options || {}, {
            profile: sourceProfileName,
            preferStaticCredentials: true,
        }));
        // --------- THIS IS NEW ----------------------
        const profiles = loadProfilesProper(this.filename);
        const region = (_d = (_b = (_a = profiles[this.profile]) === null || _a === void 0 ? void 0 : _a.region) !== null && _b !== void 0 ? _b : (_c = profiles.default) === null || _c === void 0 ? void 0 : _c.region) !== null && _d !== void 0 ? _d : 'us-east-1';
        // --------- /THIS IS NEW ----------------------
        this.roleArn = roleArn;
        var sts = new AWS.STS({
            credentials: sourceCredentials,
            region,
            httpOptions: this.httpOptions,
        });
        var roleParams = {
            RoleArn: roleArn,
            RoleSessionName: roleSessionName || 'aws-sdk-js-' + Date.now(),
        };
        if (externalId) {
            roleParams.ExternalId = externalId;
        }
        if (mfaSerial && self.tokenCodeFn) {
            roleParams.SerialNumber = mfaSerial;
            self.tokenCodeFn(mfaSerial, function (err, token) {
                if (err) {
                    var message;
                    if (err instanceof Error) {
                        message = err.message;
                    }
                    else {
                        message = err;
                    }
                    callback(AWS.util.error(new Error('Error fetching MFA token: ' + message), { code: 'SharedIniFileCredentialsProviderFailure' }));
                    return;
                }
                roleParams.TokenCode = token;
                sts.assumeRole(roleParams, callback);
            });
            return;
        }
        sts.assumeRole(roleParams, callback);
    }
}
exports.PatchedSharedIniFileCredentials = PatchedSharedIniFileCredentials;
/**
 * A function to load profiles from disk that MERGES credentials and config instead of overwriting
 *
 * @see https://github.com/aws/aws-sdk-js/blob/5ae5a7d7d24d1000dbc089cc15f8ed2c7b06c542/lib/util.js#L956
 */
function loadProfilesProper(filename) {
    const util = AWS.util; // Does exists even though there aren't any typings for it
    const iniLoader = util.iniLoader;
    const profiles = {};
    let profilesFromConfig = {};
    if (process.env[util.configOptInEnv]) {
        profilesFromConfig = iniLoader.loadFrom({
            isConfig: true,
            filename: process.env[util.sharedConfigFileEnv],
        });
    }
    var profilesFromCreds = iniLoader.loadFrom({
        filename: filename ||
            (process.env[util.configOptInEnv] && process.env[util.sharedCredentialsFileEnv]),
    });
    for (const [name, profile] of Object.entries(profilesFromConfig)) {
        profiles[name] = profile;
    }
    for (const [name, profile] of Object.entries(profilesFromCreds)) {
        profiles[name] = {
            ...profiles[name],
            ...profile,
        };
    }
    return profiles;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXdzLXNkay1pbmlmaWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXdzLXNkay1pbmlmaWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUErQjtBQUcvQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFDSCxNQUFhLCtCQUFnQyxTQUFRLEdBQUcsQ0FBQyx3QkFBd0I7SUFTeEUsZUFBZSxDQUNwQixLQUE2QyxFQUM3QyxXQUFtQyxFQUNuQyxRQUEyQztRQUUzQyxrR0FBa0c7UUFDbEcsOERBQThEOztRQUU5RCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixNQUFPLEdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUMzQixJQUFJLEtBQUssQ0FBQyx5Q0FBeUM7Z0JBQ3pDLHlCQUF5QixHQUFHLElBQUksQ0FBQyxPQUFPO2dCQUN4QyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUNwQyxFQUFFLElBQUksRUFBRSx5Q0FBeUMsRUFBRSxDQUNwRCxDQUFDO1NBQ0g7UUFFRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQztRQUNuQyxJQUFJLGVBQWUsR0FBRyxXQUFXLENBQUMsaUJBQWlCLENBQUM7UUFDcEQsSUFBSSxVQUFVLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQztRQUN6QyxJQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsVUFBVSxDQUFDO1FBQ3ZDLElBQUksaUJBQWlCLEdBQUcsV0FBVyxDQUFDLGNBQWMsQ0FBQztRQUVuRCxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDdEIsTUFBTyxHQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FDM0IsSUFBSSxLQUFLLENBQUMsMENBQTBDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUNwRSxFQUFFLElBQUksRUFBRSx5Q0FBeUMsRUFBRSxDQUNwRCxDQUFDO1NBQ0g7UUFFRCxJ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QztJQUNwRSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFO1FBQ3BDLGtCQUFrQixHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUM7WUFDdEMsUUFBUSxFQUFFLElBQUk7WUFDZCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUM7U0FDaEQsQ0FBQyxDQUFDO0tBQ0o7SUFDRCxJQUFJLGlCQUFpQixHQUEyQyxTQUFTLENBQUMsUUFBUSxDQUFDO1FBQ2pGLFFBQVEsRUFBRSxRQUFRO1lBQ2hCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQztLQUNuRixDQUFDLENBQUM7SUFDSCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO1FBQ2hFLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7S0FDMUI7SUFDRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFO1FBQy9ELFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRztZQUNmLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNqQixHQUFHLE9BQU87U0FDWCxDQUFDO0tBQ0g7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xuXG5cbi8qKlxuICogSGFjay1maXhcbiAqXG4gKiBUaGVyZSBhcmUgYSBudW1iZXIgb2YgaXNzdWVzIGluIHRoZSB1cHN0cmVhbSB2ZXJzaW9uIG9mIFNoYXJlZEluaUZpbGVDcmVkZW50aWFsc1xuICogdGhhdCBuZWVkIGZpeGluZzpcbiAqXG4gKiAgMS4gVGhlIHVwc3RyZWFtIGF3cy1zZGsgY29udGFpbnMgYW4gaW5jb3JyZWN0IGluc3RhbnRpYXRpb24gb2YgYW4gYEFXUy5TVFNgXG4gKiAgICAgY2xpZW50LCB3aGljaCAqc2hvdWxkKiBoYXZlIHRha2VuIHRoZSByZWdpb24gZnJvbSB0aGUgcmVxdWVzdGVkIHByb2ZpbGVcbiAqICAgICBidXQgZG9lc24ndC4gSXQgd2lsbCB1c2UgdGhlIHJlZ2lvbiBmcm9tIHRoZSBkZWZhdWx0IHByb2ZpbGUsIHdoaWNoXG4gKiAgICAgbWF5IG5vdCBleGlzdCwgZGVmYXVsdGluZyB0byBgdXMtZWFzdC0xYCAoc2luY2Ugd2Ugc3dpdGNoZWQgdG9cbiAqICAgICBBV1NfU1RTX1JFR0lPTkFMX0VORFBPSU5UUz1yZWdpb25hbCwgdGhhdCBkZWZhdWx0IGlzIG5vdCBldmVuIGFsbG93ZWQgYW55bW9yZVxuICogICAgIGFuZCB0aGUgYWJzZW5jZSBvZiBhIGRlZmF1bHQgcmVnaW9uIHdpbGwgbGVhZCB0byBhbiBlcnJvcikuXG4gKlxuICogIDIuIFRoZSBzaW1wbGUgZml4IGlzIHRvIGdldCB0aGUgcmVnaW9uIGZyb20gdGhlIGBjb25maWdgIGZpbGUuIHByb2ZpbGVzXG4gKiAgICAgYXJlIG1hZGUgdXAgb2YgYSBjb21iaW5hdGlvbiBvZiBgY3JlZGVudGlhbHNgIGFuZCBgY29uZmlnYCwgYW5kIHRoZSByZWdpb24gaXNcbiAqICAgICBnZW5lcmFsbHkgaW4gYGNvbmZpZ2Agd2l0aCB0aGUgcmVzdCBpbiBgY3JlZGVudGlhbHNgLiBIb3dldmVyLCBhIGJ1ZyBpblxuICogICAgIGBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWdgIG92ZXJ3cml0ZXMgQUxMIGBjb25maWdgIGRhdGEgd2l0aCBgY3JlZGVudGlhbHNgXG4gKiAgICAgZGF0YSwgc28gd2UgYWxzbyBuZWVkIHRvIGRvIGV4dHJhIHdvcmsgdG8gZmlzaCB0aGUgYHJlZ2lvbmAgb3V0IG9mIHRoZSBjb25maWcuXG4gKlxuICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLXNkay1qcy9pc3N1ZXMvMzQxOCBmb3IgYWxsIHRoZSBnb3J5IGRldGFpbHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBQYXRjaGVkU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzIGV4dGVuZHMgQVdTLlNoYXJlZEluaUZpbGVDcmVkZW50aWFscyB7XG4gIGRlY2xhcmUgcHJpdmF0ZSBwcm9maWxlOiBzdHJpbmc7XG4gIGRlY2xhcmUgcHJpdmF0ZSBmaWxlbmFtZTogc3RyaW5nO1xuICBkZWNsYXJlIHByaXZhdGUgZGlzYWJsZUFzc3VtZVJvbGU6IGJvb2xlYW47XG4gIGRlY2xhcmUgcHJpdmF0ZSBvcHRpb25zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICBkZWNsYXJlIHByaXZhdGUgcm9sZUFybjogc3RyaW5nO1xuICBkZWNsYXJlIHByaXZhdGUgaHR0cE9wdGlvbnM/OiBBV1MuSFRUUE9wdGlvbnM7XG4gIGRlY2xhcmUgcHJpdmF0ZSB0b2tlbkNvZGVGbj86IChtZmFTZXJpYWw6IHN0cmluZywgY2FsbGJhY2s6IChlcnI/OiBFcnJvciwgdG9rZW4/OiBzdHJpbmcpID0+IHZvaWQpID0+IHZvaWQ7XG5cbiAgcHVibGljIGxvYWRSb2xlUHJvZmlsZShcbiAgICBjcmVkczogUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgc3RyaW5nPj4sXG4gICAgcm9sZVByb2ZpbGU6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gICAgY2FsbGJhY2s6IChlcnI/OiBFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCkge1xuXG4gICAgLy8gTmVlZCB0byBkdXBsaWNhdGUgdGhlIHdob2xlIGltcGxlbWVudGF0aW9uIGhlcmUgLS0gdGhlIGZ1bmN0aW9uIGlzIGxvbmcgYW5kIGhhcyBiZWVuIHdyaXR0ZW4gaW5cbiAgICAvLyBzdWNoIGEgd2F5IHRoYXQgdGhlcmUgYXJlIG5vIHNtYWxsIG1vbmtleSBwYXRjaGVzIHBvc3NpYmxlLlxuXG4gICAgaWYgKHRoaXMuZGlzYWJsZUFzc3VtZVJvbGUpIHtcbiAgICAgIHRocm93IChBV1MgYXMgYW55KS51dGlsLmVycm9yKFxuICAgICAgICBuZXcgRXJyb3IoJ1JvbGUgYXNzdW1wdGlvbiBwcm9maWxlcyBhcmUgZGlzYWJsZWQuICcgK1xuICAgICAgICAgICAgICAgICAgJ0ZhaWxlZCB0byBsb2FkIHByb2ZpbGUgJyArIHRoaXMucHJvZmlsZSArXG4gICAgICAgICAgICAgICAgICAnIGZyb20gJyArIGNyZWRzLmZpbGVuYW1lKSxcbiAgICAgICAgeyBjb2RlOiAnU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJyB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdmFyIHJvbGVBcm4gPSByb2xlUHJvZmlsZS5yb2xlX2FybjtcbiAgICB2YXIgcm9sZVNlc3Npb25OYW1lID0gcm9sZVByb2ZpbGUucm9sZV9zZXNzaW9uX25hbWU7XG4gICAgdmFyIGV4dGVybmFsSWQgPSByb2xlUHJvZmlsZS5leHRlcm5hbF9pZDtcbiAgICB2YXIgbWZhU2VyaWFsID0gcm9sZVByb2ZpbGUubWZhX3NlcmlhbDtcbiAgICB2YXIgc291cmNlUHJvZmlsZU5hbWUgPSByb2xlUHJvZmlsZS5zb3VyY2VfcHJvZmlsZTtcblxuICAgIGlmICghc291cmNlUHJvZmlsZU5hbWUpIHtcbiAgICAgIHRocm93IChBV1MgYXMgYW55KS51dGlsLmVycm9yKFxuICAgICAgICBuZXcgRXJyb3IoJ3NvdXJjZV9wcm9maWxlIGlzIG5vdCBzZXQgdXNpbmcgcHJvZmlsZSAnICsgdGhpcy5wcm9maWxlKSxcbiAgICAgICAgeyBjb2RlOiAnU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJyB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB2YXIgc291cmNlUHJvZmlsZUV4aXN0YW5jZVRlc3QgPSBjcmVkc1tzb3VyY2VQcm9maWxlTmFtZV07XG5cbiAgICBpZiAodHlwZW9mIHNvdXJjZVByb2ZpbGVFeGlzdGFuY2VUZXN0ICE9PSAnb2JqZWN0Jykge1xuICAgICAgdGhyb3cgKEFXUyBhcyBhbnkpLnV0aWwuZXJyb3IoXG4gICAgICAgIG5ldyBFcnJvcignc291cmNlX3Byb2ZpbGUgJyArIHNvdXJjZVByb2ZpbGVOYW1lICsgJyB1c2luZyBwcm9maWxlICdcbiAgICAgICAgICArIHRoaXMucHJvZmlsZSArICcgZG9lcyBub3QgZXhpc3QnKSxcbiAgICAgICAgeyBjb2RlOiAnU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJyB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB2YXIgc291cmNlQ3JlZGVudGlhbHMgPSBuZXcgQVdTLlNoYXJlZEluaUZpbGVDcmVkZW50aWFscyhcbiAgICAgIChBV1MgYXMgYW55KS51dGlsLm1lcmdlKHRoaXMub3B0aW9ucyB8fCB7fSwge1xuICAgICAgICBwcm9maWxlOiBzb3VyY2VQcm9maWxlTmFtZSxcbiAgICAgICAgcHJlZmVyU3RhdGljQ3JlZGVudGlhbHM6IHRydWUsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgLy8gLS0tLS0tLS0tIFRISVMgSVMgTkVXIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBjb25zdCBwcm9maWxlcyA9IGxvYWRQcm9maWxlc1Byb3Blcih0aGlzLmZpbGVuYW1lKTtcbiAgICBjb25zdCByZWdpb24gPSBwcm9maWxlc1t0aGlzLnByb2ZpbGVdPy5yZWdpb24gPz8gcHJvZmlsZXMuZGVmYXVsdD8ucmVnaW9uID8/ICd1cy1lYXN0LTEnO1xuICAgIC8vIC0tLS0tLS0tLSAvVEhJUyBJUyBORVcgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgdGhpcy5yb2xlQXJuID0gcm9sZUFybjtcbiAgICB2YXIgc3RzID0gbmV3IEFXUy5TVFMoe1xuICAgICAgY3JlZGVudGlhbHM6IHNvdXJjZUNyZWRlbnRpYWxzLFxuICAgICAgcmVnaW9uLFxuICAgICAgaHR0cE9wdGlvbnM6IHRoaXMuaHR0cE9wdGlvbnMsXG4gICAgfSk7XG5cbiAgICB2YXIgcm9sZVBhcmFtczogQVdTLlNUUy5Bc3N1bWVSb2xlUmVxdWVzdCA9IHtcbiAgICAgIFJvbGVBcm46IHJvbGVBcm4sXG4gICAgICBSb2xlU2Vzc2lvbk5hbWU6IHJvbGVTZXNzaW9uTmFtZSB8fCAnYXdzLXNkay1qcy0nICsgRGF0ZS5ub3coKSxcbiAgICB9O1xuXG4gICAgaWYgKGV4dGVybmFsSWQpIHtcbiAgICAgIHJvbGVQYXJhbXMuRXh0ZXJuYWxJZCA9IGV4dGVybmFsSWQ7XG4gICAgfVxuXG4gICAgaWYgKG1mYVNlcmlhbCAmJiBzZWxmLnRva2VuQ29kZUZuKSB7XG4gICAgICByb2xlUGFyYW1zLlNlcmlhbE51bWJlciA9IG1mYVNlcmlhbDtcbiAgICAgIHNlbGYudG9rZW5Db2RlRm4obWZhU2VyaWFsLCBmdW5jdGlvbihlcnIsIHRva2VuKSB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICB2YXIgbWVzc2FnZTtcbiAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbWVzc2FnZSA9IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FsbGJhY2soXG4gICAgICAgICAgICAoQVdTIGFzIGFueSkudXRpbC5lcnJvcihcbiAgICAgICAgICAgICAgbmV3IEVycm9yKCdFcnJvciBmZXRjaGluZyBNRkEgdG9rZW46ICcgKyBtZXNzYWdlKSxcbiAgICAgICAgICAgICAgeyBjb2RlOiAnU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJyB9LFxuICAgICAgICAgICAgKSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgcm9sZVBhcmFtcy5Ub2tlbkNvZGUgPSB0b2tlbjtcbiAgICAgICAgc3RzLmFzc3VtZVJvbGUocm9sZVBhcmFtcywgY2FsbGJhY2spO1xuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHN0cy5hc3N1bWVSb2xlKHJvbGVQYXJhbXMsIGNhbGxiYWNrKTtcblxuICB9XG59XG5cbi8qKlxuICogQSBmdW5jdGlvbiB0byBsb2FkIHByb2ZpbGVzIGZyb20gZGlzayB0aGF0IE1FUkdFUyBjcmVkZW50aWFscyBhbmQgY29uZmlnIGluc3RlYWQgb2Ygb3ZlcndyaXRpbmdcbiAqXG4gKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MvYXdzLXNkay1qcy9ibG9iLzVhZTVhN2Q3ZDI0ZDEwMDBkYmMwODljYzE1ZjhlZDJjN2IwNmM1NDIvbGliL3V0aWwuanMjTDk1NlxuICovXG5mdW5jdGlvbiBsb2FkUHJvZmlsZXNQcm9wZXIoZmlsZW5hbWU6IHN0cmluZykge1xuICBjb25zdCB1dGlsID0gKEFXUyBhcyBhbnkpLnV0aWw7IC8vIERvZXMgZXhpc3RzIGV2ZW4gdGhvdWdoIHRoZXJlIGFyZW4ndCBhbnkgdHlwaW5ncyBmb3IgaXRcbiAgY29uc3QgaW5pTG9hZGVyID0gdXRpbC5pbmlMb2FkZXI7XG4gIGNvbnN0IHByb2ZpbGVzOiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiA9IHt9O1xuICBsZXQgcHJvZmlsZXNGcm9tQ29uZmlnOiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PiA9IHt9O1xuICBpZiAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0pIHtcbiAgICBwcm9maWxlc0Zyb21Db25maWcgPSBpbmlMb2FkZXIubG9hZEZyb20oe1xuICAgICAgaXNDb25maWc6IHRydWUsXG4gICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDb25maWdGaWxlRW52XSxcbiAgICB9KTtcbiAgfVxuICB2YXIgcHJvZmlsZXNGcm9tQ3JlZHM6IFJlY29yZDxzdHJpbmcsIFJlY29yZDxzdHJpbmcsIHN0cmluZz4+ID0gaW5pTG9hZGVyLmxvYWRGcm9tKHtcbiAgICBmaWxlbmFtZTogZmlsZW5hbWUgfHxcbiAgICAgIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSAmJiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENyZWRlbnRpYWxzRmlsZUVudl0pLFxuICB9KTtcbiAgZm9yIChjb25zdCBbbmFtZSwgcHJvZmlsZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvZmlsZXNGcm9tQ29uZmlnKSkge1xuICAgIHByb2ZpbGVzW25hbWVdID0gcHJvZmlsZTtcbiAgfVxuICBmb3IgKGNvbnN0IFtuYW1lLCBwcm9maWxlXSBvZiBPYmplY3QuZW50cmllcyhwcm9maWxlc0Zyb21DcmVkcykpIHtcbiAgICBwcm9maWxlc1tuYW1lXSA9IHtcbiAgICAgIC4uLnByb2ZpbGVzW25hbWVdLFxuICAgICAgLi4ucHJvZmlsZSxcbiAgICB9O1xuICB9XG4gIHJldHVybiBwcm9maWxlcztcbn1cbiJdfQ==