"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
require("@aws-cdk/assert/jest");
const codepipeline = require("@aws-cdk/aws-codepipeline");
const core_1 = require("@aws-cdk/core");
const cdkp = require("../lib");
const testutil_1 = require("./testutil");
let app;
let pipelineStack;
let sourceArtifact;
let cloudAssemblyArtifact;
beforeEach(() => {
    app = new testutil_1.TestApp({ outdir: 'testcdk.out' });
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testutil_1.PIPELINE_ENV });
    sourceArtifact = new codepipeline.Artifact();
    cloudAssemblyArtifact = new codepipeline.Artifact('CloudAsm');
});
afterEach(() => {
    app.cleanup();
});
test('SimpleSynthAction takes arrays of commands', () => {
    // WHEN
    new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: new cdkp.SimpleSynthAction({
            sourceArtifact,
            cloudAssemblyArtifact,
            installCommands: ['install1', 'install2'],
            buildCommands: ['build1', 'build2'],
            testCommands: ['test1', 'test2'],
            synthCommand: 'cdk synth',
        }),
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    pre_build: {
                        commands: [
                            'install1',
                            'install2',
                        ],
                    },
                    build: {
                        commands: [
                            'build1',
                            'build2',
                            'test1',
                            'test2',
                            'cdk synth',
                        ],
                    },
                },
            })),
        },
    });
});
test.each([['npm'], ['yarn']])('%s build automatically determines artifact base-directory', (npmYarn) => {
    // WHEN
    new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: npmYarnBuild(npmYarn)({ sourceArtifact, cloudAssemblyArtifact }),
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                artifacts: {
                    'base-directory': 'testcdk.out',
                },
            })),
        },
    });
});
test.each([['npm'], ['yarn']])('%s build respects subdirectory', (npmYarn) => {
    // WHEN
    new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: npmYarnBuild(npmYarn)({
            sourceArtifact,
            cloudAssemblyArtifact,
            subdirectory: 'subdir',
        }),
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    pre_build: {
                        commands: assert_1.arrayWith('cd subdir'),
                    },
                },
                artifacts: {
                    'base-directory': 'subdir/testcdk.out',
                },
            })),
        },
    });
});
test.each([['npm'], ['yarn']])('%s assumes no build step by default', (npmYarn) => {
    // WHEN
    new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: npmYarnBuild(npmYarn)({ sourceArtifact, cloudAssemblyArtifact }),
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: ['npx cdk synth'],
                    },
                },
            })),
        },
    });
});
test.each([['npm'], ['yarn']])('%s can have its install command overridden', (npmYarn) => {
    // WHEN
    new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: npmYarnBuild(npmYarn)({
            sourceArtifact,
            cloudAssemblyArtifact,
            installCommand: '/bin/true',
        }),
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    pre_build: {
                        commands: ['/bin/true'],
                    },
                },
            })),
        },
    });
});
test('Standard (NPM) synth can output additional artifacts', () => {
    // WHEN
    sourceArtifact = new codepipeline.Artifact();
    cloudAssemblyArtifact = new codepipeline.Artifact('CloudAsm');
    const addlArtifact = new codepipeline.Artifact('IntegTest');
    new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: cdkp.SimpleSynthAction.standardNpmSynth({
            sourceArtifact,
            cloudAssemblyArtifact,
            additionalArtifacts: [
                {
                    artifact: addlArtifact,
                    directory: 'test',
                },
            ],
        }),
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                artifacts: {
                    'secondary-artifacts': {
                        CloudAsm: {
                            'base-directory': 'testcdk.out',
                            'files': '**/*',
                        },
                        IntegTest: {
                            'base-directory': 'test',
                            'files': '**/*',
                        },
                    },
                },
            })),
        },
    });
});
function npmYarnBuild(npmYarn) {
    if (npmYarn === 'npm') {
        return cdkp.SimpleSynthAction.standardNpmSynth;
    }
    if (npmYarn === 'yarn') {
        return cdkp.SimpleSynthAction.standardYarnSynth;
    }
    throw new Error(`Expecting npm|yarn: ${npmYarn}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJidWlsZHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRDQUF5RTtBQUN6RSxnQ0FBOEI7QUFDOUIsMERBQTBEO0FBQzFELHdDQUFzQztBQUN0QywrQkFBK0I7QUFDL0IseUNBQTBFO0FBRTFFLElBQUksR0FBWSxDQUFDO0FBQ2pCLElBQUksYUFBb0IsQ0FBQztBQUN6QixJQUFJLGNBQXFDLENBQUM7QUFDMUMsSUFBSSxxQkFBNEMsQ0FBQztBQUVqRCxVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksa0JBQU8sQ0FBQyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLGFBQWEsR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLHVCQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLGNBQWMsR0FBRyxJQUFJLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QyxxQkFBcUIsR0FBRyxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDaEUsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO0lBQ2IsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ2hCLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLDRDQUE0QyxFQUFFLEdBQUcsRUFBRTtJQUN0RCxPQUFPO0lBQ1AsSUFBSSxnQ0FBcUIsQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFO1FBQzlDLGNBQWM7UUFDZCxxQkFBcUI7UUFDckIsV0FBVyxFQUFFLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDO1lBQ3RDLGNBQWM7WUFDZCxxQkFBcUI7WUFDckIsZUFBZSxFQUFFLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQztZQUN6QyxhQUFhLEVBQUUsQ0FBQyxRQUFRLEVB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RSxNQUFNOzRCQUN4QixPQUFPLEVBQUUsTUFBTTt5QkFDaEI7cUJBQ0Y7aUJBQ0Y7YUFDRixDQUFDLENBQUM7U0FDSjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsU0FBUyxZQUFZLENBQUMsT0FBZTtJQUNuQyxJQUFJLE9BQU8sS0FBSyxLQUFLLEVBQUU7UUFBRSxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxnQkFBZ0IsQ0FBQztLQUFFO0lBQzFFLElBQUksT0FBTyxLQUFLLE1BQU0sRUFBRTtRQUFFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDO0tBQUU7SUFDNUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsT0FBTyxFQUFFLENBQUMsQ0FBQztBQUNwRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXJyYXlXaXRoLCBkZWVwT2JqZWN0TGlrZSwgZW5jb2RlZEpzb24gfSBmcm9tICdAYXdzLWNkay9hc3NlcnQnO1xuaW1wb3J0ICdAYXdzLWNkay9hc3NlcnQvamVzdCc7XG5pbXBvcnQgKiBhcyBjb2RlcGlwZWxpbmUgZnJvbSAnQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZSc7XG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgY2RrcCBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgUElQRUxJTkVfRU5WLCBUZXN0QXBwLCBUZXN0R2l0SHViTnBtUGlwZWxpbmUgfSBmcm9tICcuL3Rlc3R1dGlsJztcblxubGV0IGFwcDogVGVzdEFwcDtcbmxldCBwaXBlbGluZVN0YWNrOiBTdGFjaztcbmxldCBzb3VyY2VBcnRpZmFjdDogY29kZXBpcGVsaW5lLkFydGlmYWN0O1xubGV0IGNsb3VkQXNzZW1ibHlBcnRpZmFjdDogY29kZXBpcGVsaW5lLkFydGlmYWN0O1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgYXBwID0gbmV3IFRlc3RBcHAoeyBvdXRkaXI6ICd0ZXN0Y2RrLm91dCcgfSk7XG4gIHBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnUGlwZWxpbmVTdGFjaycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gIHNvdXJjZUFydGlmYWN0ID0gbmV3IGNvZGVwaXBlbGluZS5BcnRpZmFjdCgpO1xuICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QgPSBuZXcgY29kZXBpcGVsaW5lLkFydGlmYWN0KCdDbG91ZEFzbScpO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGFwcC5jbGVhbnVwKCk7XG59KTtcblxudGVzdCgnU2ltcGxlU3ludGhBY3Rpb24gdGFrZXMgYXJyYXlzIG9mIGNvbW1hbmRzJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICBzb3VyY2VBcnRpZmFjdCxcbiAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgc3ludGhBY3Rpb246IG5ldyBjZGtwLlNpbXBsZVN5bnRoQWN0aW9uKHtcbiAgICAgIHNvdXJjZUFydGlmYWN0LFxuICAgICAgY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgICAgaW5zdGFsbENvbW1hbmRzOiBbJ2luc3RhbGwxJywgJ2luc3RhbGwyJ10sXG4gICAgICBidWlsZENvbW1hbmRzOiBbJ2J1aWxkMScsICdidWlsZDInXSxcbiAgICAgIHRlc3RDb21tYW5kczogWyd0ZXN0MScsICd0ZXN0MiddLFxuICAgICAgc3ludGhDb21tYW5kOiAnY2RrIHN5bnRoJyxcbiAgICB9KSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBFbnZpcm9ubWVudDoge1xuICAgICAgSW1hZ2U6ICdhd3MvY29kZWJ1aWxkL3N0YW5kYXJkOjQuMCcsXG4gICAgfSxcbiAgICBTb3VyY2U6IHtcbiAgICAgIEJ1aWxkU3BlYzogZW5jb2RlZEpzb24oZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBwcmVfYnVpbGQ6IHtcbiAgICAgICAgICAgIGNvbW1hbmRzOiBbXG4gICAgICAgICAgICAgICdpbnN0YWxsMScsXG4gICAgICAgICAgICAgICdpbnN0YWxsMicsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgYnVpbGQ6IHtcbiAgICAgICAgICAgIGNvbW1hbmRzOiBbXG4gICAgICAgICAgICAgICdidWlsZDEnLFxuICAgICAgICAgICAgICAnYnVpbGQyJyxcbiAgICAgICAgICAgICAgJ3Rlc3QxJyxcbiAgICAgICAgICAgICAgJ3Rlc3QyJyxcbiAgICAgICAgICAgICAgJ2NkayBzeW50aCcsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdC5lYWNoKFtbJ25wbSddLCBbJ3lhcm4nXV0pKCclcyBidWlsZCBhdXRvbWF0aWNhbGx5IGRldGVybWluZXMgYXJ0aWZhY3QgYmFzZS1kaXJlY3RvcnknLCAobnBtWWFybikgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICBzb3VyY2VBcnRpZmFjdCxcbiAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgc3ludGhBY3Rpb246IG5wbVlhcm5CdWlsZChucG1ZYXJuKSh7IHNvdXJjZUFydGlmYWN0LCBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QgfSksXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgIEltYWdlOiAnYXdzL2NvZGVidWlsZC9zdGFuZGFyZDo0LjAnLFxuICAgIH0sXG4gICAgU291cmNlOiB7XG4gICAgICBCdWlsZFNwZWM6IGVuY29kZWRKc29uKGRlZXBPYmplY3RMaWtlKHtcbiAgICAgICAgYXJ0aWZhY3RzOiB7XG4gICAgICAgICAgJ2Jhc2UtZGlyZWN0b3J5JzogJ3Rlc3RjZGsub3V0JyxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0LmVhY2goW1snbnBtJ10sIFsneWFybiddXSkoJyVzIGJ1aWxkIHJlc3BlY3RzIHN1YmRpcmVjdG9yeScsIChucG1ZYXJuKSA9PiB7XG4gIC8vIFdIRU5cbiAgbmV3IFRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJywge1xuICAgIHNvdXJjZUFydGlmYWN0LFxuICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdCxcbiAgICBzeW50aEFjdGlvbjogbnBtWWFybkJ1aWxkKG5wbVlhcm4pKHtcbiAgICAgIHNvdXJjZUFydGlmYWN0LFxuICAgICAgY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgICAgc3ViZGlyZWN0b3J5OiAnc3ViZGlyJyxcbiAgICB9KSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBFbnZpcm9ubWVudDoge1xuICAgICAgSW1hZ2U6ICdhd3MvY29kZWJ1aWxkL3N0YW5kYXJkOjQuMCcsXG4gICAgfSxcbiAgICBTb3VyY2U6IHtcbiAgICAgIEJ1aWxkU3BlYzogZW5jb2RlZEpzb24oZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBwcmVfYnVpbGQ6IHtcbiAgICAgICAgICAgIGNvbW1hbmRzOiBhcnJheVdpdGgoJ2NkIHN1YmRpcicpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGFydGlmYWN0czoge1xuICAgICAgICAgICdiYXNlLWRpcmVjdG9yeSc6ICdzdWJkaXIvdGVzdGNkay5vdXQnLFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QuZWFjaChbWyducG0nXSwgWyd5YXJuJ11dKSgnJXMgYXNzdW1lcyBubyBidWlsZCBzdGVwIGJ5IGRlZmF1bHQnLCAobnBtWWFybikgPT4ge1xuICAvLyBXSEVOXG4gIG5ldyBUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICBzb3VyY2VBcnRpZmFjdCxcbiAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgc3ludGhBY3Rpb246IG5wbVlhcm5CdWlsZChucG1ZYXJuKSh7IHNvdXJjZUFydGlmYWN0LCBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QgfSksXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgIEltYWdlOiAnYXdzL2NvZGVidWlsZC9zdGFuZGFyZDo0LjAnLFxuICAgIH0sXG4gICAgU291cmNlOiB7XG4gICAgICBCdWlsZFNwZWM6IGVuY29kZWRKc29uKGRlZXBPYmplY3RMaWtlKHtcbiAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgYnVpbGQ6IHtcbiAgICAgICAgICAgIGNvbW1hbmRzOiBbJ25weCBjZGsgc3ludGgnXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QuZWFjaChbWyducG0nXSwgWyd5YXJuJ11dKSgnJXMgY2FuIGhhdmUgaXRzIGluc3RhbGwgY29tbWFuZCBvdmVycmlkZGVuJywgKG5wbVlhcm4pID0+IHtcbiAgLy8gV0hFTlxuICBuZXcgVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnLCB7XG4gICAgc291cmNlQXJ0aWZhY3QsXG4gICAgY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgIHN5bnRoQWN0aW9uOiBucG1ZYXJuQnVpbGQobnBtWWFybikoe1xuICAgICAgc291cmNlQXJ0aWZhY3QsXG4gICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICBpbnN0YWxsQ29tbWFuZDogJy9iaW4vdHJ1ZScsXG4gICAgfSksXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgIEltYWdlOiAnYXdzL2NvZGVidWlsZC9zdGFuZGFyZDo0LjAnLFxuICAgIH0sXG4gICAgU291cmNlOiB7XG4gICAgICBCdWlsZFNwZWM6IGVuY29kZWRKc29uKGRlZXBPYmplY3RMaWtlKHtcbiAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgcHJlX2J1aWxkOiB7XG4gICAgICAgICAgICBjb21tYW5kczogWycvYmluL3RydWUnXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgIH0sXG4gIH0pO1xufSk7XG5cbnRlc3QoJ1N0YW5kYXJkIChOUE0pIHN5bnRoIGNhbiBvdXRwdXQgYWRkaXRpb25hbCBhcnRpZmFjdHMnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgc291cmNlQXJ0aWZhY3QgPSBuZXcgY29kZXBpcGVsaW5lLkFydGlmYWN0KCk7XG4gIGNsb3VkQXNzZW1ibHlBcnRpZmFjdCA9IG5ldyBjb2RlcGlwZWxpbmUuQXJ0aWZhY3QoJ0Nsb3VkQXNtJyk7XG5cbiAgY29uc3QgYWRkbEFydGlmYWN0ID0gbmV3IGNvZGVwaXBlbGluZS5BcnRpZmFjdCgnSW50ZWdUZXN0Jyk7XG4gIG5ldyBUZXN0R2l0SHViTnBtUGlwZWxpbmUocGlwZWxpbmVTdGFjaywgJ0NkaycsIHtcbiAgICBzb3VyY2VBcnRpZmFjdCxcbiAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgc3ludGhBY3Rpb246IGNka3AuU2ltcGxlU3ludGhBY3Rpb24uc3RhbmRhcmROcG1TeW50aCh7XG4gICAgICBzb3VyY2VBcnRpZmFjdCxcbiAgICAgIGNsb3VkQXNzZW1ibHlBcnRpZmFjdCxcbiAgICAgIGFkZGl0aW9uYWxBcnRpZmFjdHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIGFydGlmYWN0OiBhZGRsQXJ0aWZhY3QsXG4gICAgICAgICAgZGlyZWN0b3J5OiAndGVzdCcsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIEVudmlyb25tZW50OiB7XG4gICAgICBJbWFnZTogJ2F3cy9jb2RlYnVpbGQvc3RhbmRhcmQ6NC4wJyxcbiAgICB9LFxuICAgIFNvdXJjZToge1xuICAgICAgQnVpbGRTcGVjOiBlbmNvZGVkSnNvbihkZWVwT2JqZWN0TGlrZSh7XG4gICAgICAgIGFydGlmYWN0czoge1xuICAgICAgICAgICdzZWNvbmRhcnktYXJ0aWZhY3RzJzoge1xuICAgICAgICAgICAgQ2xvdWRBc206IHtcbiAgICAgICAgICAgICAgJ2Jhc2UtZGlyZWN0b3J5JzogJ3Rlc3RjZGsub3V0JyxcbiAgICAgICAgICAgICAgJ2ZpbGVzJzogJyoqLyonLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIEludGVnVGVzdDoge1xuICAgICAgICAgICAgICAnYmFzZS1kaXJlY3RvcnknOiAndGVzdCcsXG4gICAgICAgICAgICAgICdmaWxlcyc6ICcqKi8qJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG5mdW5jdGlvbiBucG1ZYXJuQnVpbGQobnBtWWFybjogc3RyaW5nKSB7XG4gIGlmIChucG1ZYXJuID09PSAnbnBtJykgeyByZXR1cm4gY2RrcC5TaW1wbGVTeW50aEFjdGlvbi5zdGFuZGFyZE5wbVN5bnRoOyB9XG4gIGlmIChucG1ZYXJuID09PSAneWFybicpIHsgcmV0dXJuIGNka3AuU2ltcGxlU3ludGhBY3Rpb24uc3RhbmRhcmRZYXJuU3ludGg7IH1cbiAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RpbmcgbnBtfHlhcm46ICR7bnBtWWFybn1gKTtcbn0iXX0=