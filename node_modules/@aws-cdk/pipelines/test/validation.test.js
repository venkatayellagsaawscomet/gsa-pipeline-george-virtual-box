"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
require("@aws-cdk/assert/jest");
const codepipeline = require("@aws-cdk/aws-codepipeline");
const core_1 = require("@aws-cdk/core");
const cdkp = require("../lib");
const testutil_1 = require("./testutil");
let app;
let pipelineStack;
let pipeline;
let sourceArtifact;
let cloudAssemblyArtifact;
let integTestArtifact;
beforeEach(() => {
    app = new testutil_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testutil_1.PIPELINE_ENV });
    sourceArtifact = new codepipeline.Artifact();
    cloudAssemblyArtifact = new codepipeline.Artifact('CloudAsm');
    integTestArtifact = new codepipeline.Artifact('IntegTests');
    pipeline = new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk', {
        sourceArtifact,
        cloudAssemblyArtifact,
        synthAction: cdkp.SimpleSynthAction.standardNpmSynth({
            sourceArtifact,
            cloudAssemblyArtifact,
            additionalArtifacts: [{ directory: 'test', artifact: integTestArtifact }],
        }),
    });
});
afterEach(() => {
    app.cleanup();
});
test('can use stack outputs as validation inputs', () => {
    // GIVEN
    const stage = new AppWithStackOutput(app, 'MyApp');
    // WHEN
    const pipeStage = pipeline.addApplicationStage(stage);
    pipeStage.addActions(new cdkp.ShellScriptAction({
        actionName: 'TestOutput',
        useOutputs: {
            BUCKET_NAME: pipeline.stackOutput(stage.output),
        },
        commands: ['echo $BUCKET_NAME'],
    }));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'MyApp',
            Actions: assert_1.arrayWith(assert_1.deepObjectLike({
                Name: 'Stack.Deploy',
                OutputArtifacts: [{ Name: assert_1.anything() }],
                Configuration: {
                    OutputFileName: 'outputs.json',
                },
            }), assert_1.deepObjectLike({
                ActionTypeId: {
                    Provider: 'CodeBuild',
                },
                Configuration: {
                    ProjectName: assert_1.anything(),
                },
                InputArtifacts: [{ Name: assert_1.anything() }],
                Name: 'TestOutput',
            })),
        }),
    });
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: [
                            'set -eu',
                            'export BUCKET_NAME="$(node -pe \'require(process.env.CODEBUILD_SRC_DIR + "/outputs.json")["BucketName"]\')"',
                            'echo $BUCKET_NAME',
                        ],
                    },
                },
            })),
            Type: 'CODEPIPELINE',
        },
    });
});
test('can use additional files from source', () => {
    // WHEN
    pipeline.addStage('Test').addActions(new cdkp.ShellScriptAction({
        actionName: 'UseSources',
        additionalArtifacts: [sourceArtifact],
        commands: ['true'],
    }));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'Test',
            Actions: [
                assert_1.deepObjectLike({
                    Name: 'UseSources',
                    InputArtifacts: [{ Name: 'Artifact_Source_GitHub' }],
                }),
            ],
        }),
    });
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: [
                            'set -eu',
                            'true',
                        ],
                    },
                },
            })),
        },
    });
});
test('can use additional files from build', () => {
    // WHEN
    pipeline.addStage('Test').addActions(new cdkp.ShellScriptAction({
        actionName: 'UseBuildArtifact',
        additionalArtifacts: [integTestArtifact],
        commands: ['true'],
    }));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'Test',
            Actions: [
                assert_1.deepObjectLike({
                    Name: 'UseBuildArtifact',
                    InputArtifacts: [{ Name: 'IntegTests' }],
                }),
            ],
        }),
    });
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: [
                            'set -eu',
                            'true',
                        ],
                    },
                },
            })),
        },
    });
});
class AppWithStackOutput extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new testutil_1.BucketStack(this, 'Stack');
        this.output = new core_1.CfnOutput(stack, 'BucketName', {
            value: stack.bucket.bucketName,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidmFsaWRhdGlvbi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNENBQW1GO0FBQ25GLGdDQUE4QjtBQUM5QiwwREFBMEQ7QUFDMUQsd0NBQStFO0FBQy9FLCtCQUErQjtBQUUvQix5Q0FBdUY7QUFFdkYsSUFBSSxHQUFZLENBQUM7QUFDakIsSUFBSSxhQUFvQixDQUFDO0FBQ3pCLElBQUksUUFBMEIsQ0FBQztBQUMvQixJQUFJLGNBQXFDLENBQUM7QUFDMUMsSUFBSSxxQkFBNEMsQ0FBQztBQUNqRCxJQUFJLGlCQUF3QyxDQUFDO0FBRTdDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxHQUFHLEdBQUcsSUFBSSxrQkFBTyxFQUFFLENBQUM7SUFDcEIsYUFBYSxHQUFHLElBQUksWUFBSyxDQUFDLEdBQUcsRUFBRSxlQUFlLEVBQUUsRUFBRSxHQUFHLEVBQUUsdUJBQVksRUFBRSxDQUFDLENBQUM7SUFDdkUsY0FBYyxHQUFHLElBQUksWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzdDLHFCQUFxQixHQUFHLElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM5RCxpQkFBaUIsR0FBRyxJQUFJLFlBQVksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDNUQsUUFBUSxHQUFHLElBQUksZ0NBQXFCLENBQUMsYUFBYSxFQUFFLEtBQUssRUFBRTtRQUN6RCxjQUFjO1FBQ2QscUJBQXFCO1FBQ3JCLFdBQVcsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUM7WUFDbkQsY0FBYztZQUNkLHFCQUFxQjtZQUNyQixtQkFBbUIsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQztTQUMxRSxDQUFDO0tBQ0gsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFD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RUFBRTtZQUNOLFNBQVMsRUFBRSxvQkFBVyxDQUFDLHVCQUFjLENBQUM7Z0JBQ3BDLE1BQU0sRUFBRTtvQkFDTixLQUFLLEVBQUU7d0JBQ0wsUUFBUSxFQUFFOzRCQUNSLFNBQVM7NEJBQ1QsTUFBTTt5QkFDUDtxQkFDRjtpQkFDRjthQUNGLENBQUMsQ0FBQztTQUNKO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLGtCQUFtQixTQUFRLFlBQUs7SUFHcEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFrQjtRQUMxRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QixNQUFNLEtBQUssR0FBRyxJQUFJLHNCQUFXLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRTdDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxnQkFBUyxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUU7WUFDL0MsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVTtTQUMvQixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhbnl0aGluZywgYXJyYXlXaXRoLCBkZWVwT2JqZWN0TGlrZSwgZW5jb2RlZEpzb24gfSBmcm9tICdAYXdzLWNkay9hc3NlcnQnO1xuaW1wb3J0ICdAYXdzLWNkay9hc3NlcnQvamVzdCc7XG5pbXBvcnQgKiBhcyBjb2RlcGlwZWxpbmUgZnJvbSAnQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZSc7XG5pbXBvcnQgeyBDZm5PdXRwdXQsIENvbnN0cnVjdCwgU3RhY2ssIFN0YWdlLCBTdGFnZVByb3BzIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgKiBhcyBjZGtwIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyB9IGZyb20gJy4vdGVzdG1hdGNoZXJzJztcbmltcG9ydCB7IEJ1Y2tldFN0YWNrLCBQSVBFTElORV9FTlYsIFRlc3RBcHAsIFRlc3RHaXRIdWJOcG1QaXBlbGluZSB9IGZyb20gJy4vdGVzdHV0aWwnO1xuXG5sZXQgYXBwOiBUZXN0QXBwO1xubGV0IHBpcGVsaW5lU3RhY2s6IFN0YWNrO1xubGV0IHBpcGVsaW5lOiBjZGtwLkNka1BpcGVsaW5lO1xubGV0IHNvdXJjZUFydGlmYWN0OiBjb2RlcGlwZWxpbmUuQXJ0aWZhY3Q7XG5sZXQgY2xvdWRBc3NlbWJseUFydGlmYWN0OiBjb2RlcGlwZWxpbmUuQXJ0aWZhY3Q7XG5sZXQgaW50ZWdUZXN0QXJ0aWZhY3Q6IGNvZGVwaXBlbGluZS5BcnRpZmFjdDtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGFwcCA9IG5ldyBUZXN0QXBwKCk7XG4gIHBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnUGlwZWxpbmVTdGFjaycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gIHNvdXJjZUFydGlmYWN0ID0gbmV3IGNvZGVwaXBlbGluZS5BcnRpZmFjdCgpO1xuICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QgPSBuZXcgY29kZXBpcGVsaW5lLkFydGlmYWN0KCdDbG91ZEFzbScpO1xuICBpbnRlZ1Rlc3RBcnRpZmFjdCA9IG5ldyBjb2RlcGlwZWxpbmUuQXJ0aWZhY3QoJ0ludGVnVGVzdHMnKTtcbiAgcGlwZWxpbmUgPSBuZXcgVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHBpcGVsaW5lU3RhY2ssICdDZGsnLCB7XG4gICAgc291cmNlQXJ0aWZhY3QsXG4gICAgY2xvdWRBc3NlbWJseUFydGlmYWN0LFxuICAgIHN5bnRoQWN0aW9uOiBjZGtwLlNpbXBsZVN5bnRoQWN0aW9uLnN0YW5kYXJkTnBtU3ludGgoe1xuICAgICAgc291cmNlQXJ0aWZhY3QsXG4gICAgICBjbG91ZEFzc2VtYmx5QXJ0aWZhY3QsXG4gICAgICBhZGRpdGlvbmFsQXJ0aWZhY3RzOiBbeyBkaXJlY3Rvcnk6ICd0ZXN0JywgYXJ0aWZhY3Q6IGludGVnVGVzdEFydGlmYWN0IH1dLFxuICAgIH0pLFxuICB9KTtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBhcHAuY2xlYW51cCgpO1xufSk7XG5cbnRlc3QoJ2NhbiB1c2Ugc3RhY2sgb3V0cHV0cyBhcyB2YWxpZGF0aW9uIGlucHV0cycsICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhZ2UgPSBuZXcgQXBwV2l0aFN0YWNrT3V0cHV0KGFwcCwgJ015QXBwJyk7XG5cbiAgLy8gV0hFTlxuICBjb25zdCBwaXBlU3RhZ2UgPSBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKHN0YWdlKTtcbiAgcGlwZVN0YWdlLmFkZEFjdGlvbnMobmV3IGNka3AuU2hlbGxTY3JpcHRBY3Rpb24oe1xuICAgIGFjdGlvbk5hbWU6ICdUZXN0T3V0cHV0JyxcbiAgICB1c2VPdXRwdXRzOiB7XG4gICAgICBCVUNLRVRfTkFNRTogcGlwZWxpbmUuc3RhY2tPdXRwdXQoc3RhZ2Uub3V0cHV0KSxcbiAgICB9LFxuICAgIGNvbW1hbmRzOiBbJ2VjaG8gJEJVQ0tFVF9OQU1FJ10sXG4gIH0pKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICBTdGFnZXM6IGFycmF5V2l0aCh7XG4gICAgICBOYW1lOiAnTXlBcHAnLFxuICAgICAgQWN0aW9uczogYXJyYXlXaXRoKFxuICAgICAgICBkZWVwT2JqZWN0TGlrZSh7XG4gICAgICAgICAgTmFtZTogJ1N0YWNrLkRlcGxveScsXG4gICAgICAgICAgT3V0cHV0QXJ0aWZhY3RzOiBbeyBOYW1lOiBhbnl0aGluZygpIH1dLFxuICAgICAgICAgIENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgIE91dHB1dEZpbGVOYW1lOiAnb3V0cHV0cy5qc29uJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAgZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICAgIEFjdGlvblR5cGVJZDoge1xuICAgICAgICAgICAgUHJvdmlkZXI6ICdDb2RlQnVpbGQnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgQ29uZmlndXJhdGlvbjoge1xuICAgICAgICAgICAgUHJvamVjdE5hbWU6IGFueXRoaW5nKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgICBJbnB1dEFydGlmYWN0czogW3sgTmFtZTogYW55dGhpbmcoKSB9XSxcbiAgICAgICAgICBOYW1lOiAnVGVzdE91dHB1dCcsXG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICB9KSxcbiAgfSk7XG5cbiAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlQnVpbGQ6OlByb2plY3QnLCB7XG4gICAgRW52aXJvbm1lbnQ6IHtcbiAgICAgIEltYWdlOiAnYXdzL2NvZGVidWlsZC9zdGFuZGFyZDo0LjAnLFxuICAgIH0sXG4gICAgU291cmNlOiB7XG4gICAgICBCdWlsZFNwZWM6IGVuY29kZWRKc29uKGRlZXBPYmplY3RMaWtlKHtcbiAgICAgICAgcGhhc2VzOiB7XG4gICAgICAgICAgYnVpbGQ6IHtcbiAgICAgICAgICAgIGNvbW1hbmRzOiBbXG4gICAgICAgICAgICAgICdzZXQgLWV1JyxcbiAgICAgICAgICAgICAgJ2V4cG9ydCBCVUNLRVRfTkFNRT1cIiQobm9kZSAtcGUgXFwncmVxdWlyZShwcm9jZXNzLmVudi5DT0RFQlVJTERfU1JDX0RJUiArIFwiL291dHB1dHMuanNvblwiKVtcIkJ1Y2tldE5hbWVcIl1cXCcpXCInLFxuICAgICAgICAgICAgICAnZWNobyAkQlVDS0VUX05BTUUnLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgICAgVHlwZTogJ0NPREVQSVBFTElORScsXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnY2FuIHVzZSBhZGRpdGlvbmFsIGZpbGVzIGZyb20gc291cmNlJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIHBpcGVsaW5lLmFkZFN0YWdlKCdUZXN0JykuYWRkQWN0aW9ucyhuZXcgY2RrcC5TaGVsbFNjcmlwdEFjdGlvbih7XG4gICAgYWN0aW9uTmFtZTogJ1VzZVNvdXJjZXMnLFxuICAgIGFkZGl0aW9uYWxBcnRpZmFjdHM6IFtzb3VyY2VBcnRpZmFjdF0sXG4gICAgY29tbWFuZHM6IFsndHJ1ZSddLFxuICB9KSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgU3RhZ2VzOiBhcnJheVdpdGgoe1xuICAgICAgTmFtZTogJ1Rlc3QnLFxuICAgICAgQWN0aW9uczogW1xuICAgICAgICBkZWVwT2JqZWN0TGlrZSh7XG4gICAgICAgICAgTmFtZTogJ1VzZVNvdXJjZXMnLFxuICAgICAgICAgIElucHV0QXJ0aWZhY3RzOiBbeyBOYW1lOiAnQXJ0aWZhY3RfU291cmNlX0dpdEh1YicgfV0sXG4gICAgICAgIH0pLFxuICAgICAgXSxcbiAgICB9KSxcbiAgfSk7XG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIEVudmlyb25tZW50OiB7XG4gICAgICBJbWFnZTogJ2F3cy9jb2RlYnVpbGQvc3RhbmRhcmQ6NC4wJyxcbiAgICB9LFxuICAgIFNvdXJjZToge1xuICAgICAgQnVpbGRTcGVjOiBlbmNvZGVkSnNvbihkZWVwT2JqZWN0TGlrZSh7XG4gICAgICAgIHBoYXNlczoge1xuICAgICAgICAgIGJ1aWxkOiB7XG4gICAgICAgICAgICBjb21tYW5kczogW1xuICAgICAgICAgICAgICAnc2V0IC1ldScsXG4gICAgICAgICAgICAgICd0cnVlJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjYW4gdXNlIGFkZGl0aW9uYWwgZmlsZXMgZnJvbSBidWlsZCcsICgpID0+IHtcbiAgLy8gV0hFTlxuICBwaXBlbGluZS5hZGRTdGFnZSgnVGVzdCcpLmFkZEFjdGlvbnMobmV3IGNka3AuU2hlbGxTY3JpcHRBY3Rpb24oe1xuICAgIGFjdGlvbk5hbWU6ICdVc2VCdWlsZEFydGlmYWN0JyxcbiAgICBhZGRpdGlvbmFsQXJ0aWZhY3RzOiBbaW50ZWdUZXN0QXJ0aWZhY3RdLFxuICAgIGNvbW1hbmRzOiBbJ3RydWUnXSxcbiAgfSkpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgIFN0YWdlczogYXJyYXlXaXRoKHtcbiAgICAgIE5hbWU6ICdUZXN0JyxcbiAgICAgIEFjdGlvbnM6IFtcbiAgICAgICAgZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICAgIE5hbWU6ICdVc2VCdWlsZEFydGlmYWN0JyxcbiAgICAgICAgICBJbnB1dEFydGlmYWN0czogW3sgTmFtZTogJ0ludGVnVGVzdHMnIH1dLFxuICAgICAgICB9KSxcbiAgICAgIF0sXG4gICAgfSksXG4gIH0pO1xuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBFbnZpcm9ubWVudDoge1xuICAgICAgSW1hZ2U6ICdhd3MvY29kZWJ1aWxkL3N0YW5kYXJkOjQuMCcsXG4gICAgfSxcbiAgICBTb3VyY2U6IHtcbiAgICAgIEJ1aWxkU3BlYzogZW5jb2RlZEpzb24oZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgY29tbWFuZHM6IFtcbiAgICAgICAgICAgICAgJ3NldCAtZXUnLFxuICAgICAgICAgICAgICAndHJ1ZScsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgfSxcbiAgfSk7XG59KTtcblxuY2xhc3MgQXBwV2l0aFN0YWNrT3V0cHV0IGV4dGVuZHMgU3RhZ2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgb3V0cHV0OiBDZm5PdXRwdXQ7XG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFnZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrJyk7XG5cbiAgICB0aGlzLm91dHB1dCA9IG5ldyBDZm5PdXRwdXQoc3RhY2ssICdCdWNrZXROYW1lJywge1xuICAgICAgdmFsdWU6IHN0YWNrLmJ1Y2tldC5idWNrZXROYW1lLFxuICAgIH0pO1xuICB9XG59Il19