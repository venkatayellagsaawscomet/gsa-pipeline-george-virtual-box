"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
require("@aws-cdk/assert/jest");
const ecr_assets = require("@aws-cdk/aws-ecr-assets");
const s3_assets = require("@aws-cdk/aws-s3-assets");
const core_1 = require("@aws-cdk/core");
const path = require("path");
const testutil_1 = require("./testutil");
const FILE_ASSET_SOURCE_HASH = '8289faf53c7da377bb2b90615999171adef5e1d8f6b88810e5fef75e6ca09ba5';
let app;
let pipelineStack;
let pipeline;
beforeEach(() => {
    app = new testutil_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testutil_1.PIPELINE_ENV });
    pipeline = new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk');
});
afterEach(() => {
    app.cleanup();
});
test('no assets stage if the application has no assets', () => {
    // WHEN
    pipeline.addApplicationStage(new PlainStackApp(app, 'App'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.notMatching(assert_1.arrayWith(assert_1.objectLike({
            Name: 'Assets',
        }))),
    });
});
test('command line properly locates assets in subassembly', () => {
    // WHEN
    pipeline.addApplicationStage(new FileAssetApp(app, 'FileAssetApp'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: assert_1.arrayWith(`cdk-assets --path "assembly-FileAssetApp/FileAssetAppStackEADD68C5.assets.json" --verbose publish "${FILE_ASSET_SOURCE_HASH}:current_account-current_region"`),
                    },
                },
            })),
        },
    });
});
test('multiple assets are published in parallel', () => {
    // WHEN
    pipeline.addApplicationStage(new TwoFileAssetsApp(app, 'FileAssetApp'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'Assets',
            Actions: [
                assert_1.objectLike({ RunOrder: 1 }),
                assert_1.objectLike({ RunOrder: 1 }),
            ],
        }),
    });
});
test('assets are also published when using the lower-level addStackArtifactDeployment', () => {
    // GIVEN
    const asm = new FileAssetApp(app, 'FileAssetApp').synth();
    // WHEN
    pipeline.addStage('SomeStage').addStackArtifactDeployment(asm.getStackByName('FileAssetApp-Stack'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'Assets',
            Actions: [
                assert_1.objectLike({
                    Name: 'FileAsset1',
                    RunOrder: 1,
                }),
            ],
        }),
    });
});
test('file image asset publishers do not use privilegedmode, have right AssumeRole', () => {
    // WHEN
    pipeline.addApplicationStage(new FileAssetApp(app, 'FileAssetApp'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: assert_1.arrayWith(assert_1.stringLike('cdk-assets *')),
                    },
                },
            })),
        },
        Environment: assert_1.objectLike({
            PrivilegedMode: false,
            Image: 'aws/codebuild/standard:4.0',
        }),
    });
    expect(pipelineStack).toHaveResourceLike('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: assert_1.arrayWith({
                Action: 'sts:AssumeRole',
                Effect: 'Allow',
                Resource: 'arn:*:iam::*:role/*-file-publishing-role-*',
            }),
        },
    });
});
test('docker image asset publishers use privilegedmode, have right AssumeRole', () => {
    // WHEN
    pipeline.addApplicationStage(new DockerAssetApp(app, 'DockerAssetApp'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodeBuild::Project', {
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    build: {
                        commands: assert_1.arrayWith(assert_1.stringLike('cdk-assets *')),
                    },
                },
            })),
        },
        Environment: assert_1.objectLike({
            Image: 'aws/codebuild/standard:4.0',
            PrivilegedMode: true,
        }),
    });
    expect(pipelineStack).toHaveResourceLike('AWS::IAM::Policy', {
        PolicyDocument: {
            Statement: assert_1.arrayWith({
                Action: 'sts:AssumeRole',
                Effect: 'Allow',
                Resource: 'arn:*:iam::*:role/*-image-publishing-role-*',
            }),
        },
    });
});
test('can control fix/CLI version used in pipeline selfupdate', () => {
    // WHEN
    const stack2 = new core_1.Stack(app, 'Stack2', { env: testutil_1.PIPELINE_ENV });
    const pipeline2 = new testutil_1.TestGitHubNpmPipeline(stack2, 'Cdk2', {
        cdkCliVersion: '1.2.3',
    });
    pipeline2.addApplicationStage(new FileAssetApp(stack2, 'FileAssetApp'));
    // THEN
    expect(stack2).toHaveResourceLike('AWS::CodeBuild::Project', {
        Environment: {
            Image: 'aws/codebuild/standard:4.0',
        },
        Source: {
            BuildSpec: assert_1.encodedJson(assert_1.deepObjectLike({
                phases: {
                    install: {
                        commands: 'npm install -g cdk-assets@1.2.3',
                    },
                },
            })),
        },
    });
});
describe('asset roles and policies', () => {
    test('includes file publishing assets role for apps with file assets', () => {
        pipeline.addApplicationStage(new FileAssetApp(app, 'App1'));
        expect(pipelineStack).toHaveResourceLike('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [{
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: {
                            Service: 'codebuild.amazonaws.com',
                            AWS: {
                                'Fn::Join': ['', [
                                        'arn:', { Ref: 'AWS::Partition' }, `:iam::${testutil_1.PIPELINE_ENV.account}:root`,
                                    ]],
                            },
                        },
                    }],
            },
        });
        expect(pipelineStack).toHaveResourceLike('AWS::IAM::Policy', expectedAssetRolePolicy('arn:*:iam::*:role/*-file-publishing-role-*', 'CdkAssetsFileRole6BE17A07'));
    });
    test('includes image publishing assets role for apps with Docker assets', () => {
        pipeline.addApplicationStage(new DockerAssetApp(app, 'App1'));
        expect(pipelineStack).toHaveResourceLike('AWS::IAM::Role', {
            AssumeRolePolicyDocument: {
                Statement: [{
                        Action: 'sts:AssumeRole',
                        Effect: 'Allow',
                        Principal: {
                            Service: 'codebuild.amazonaws.com',
                            AWS: {
                                'Fn::Join': ['', [
                                        'arn:', { Ref: 'AWS::Partition' }, `:iam::${testutil_1.PIPELINE_ENV.account}:root`,
                                    ]],
                            },
                        },
                    }],
            },
        });
        expect(pipelineStack).toHaveResourceLike('AWS::IAM::Policy', expectedAssetRolePolicy('arn:*:iam::*:role/*-image-publishing-role-*', 'CdkAssetsDockerRole484B6DD3'));
    });
    test('includes both roles for apps with both file and Docker assets', () => {
        pipeline.addApplicationStage(new FileAssetApp(app, 'App1'));
        pipeline.addApplicationStage(new DockerAssetApp(app, 'App2'));
        expect(pipelineStack).toHaveResourceLike('AWS::IAM::Policy', expectedAssetRolePolicy('arn:*:iam::*:role/*-file-publishing-role-*', 'CdkAssetsFileRole6BE17A07'));
        expect(pipelineStack).toHaveResourceLike('AWS::IAM::Policy', expectedAssetRolePolicy('arn:*:iam::*:role/*-image-publishing-role-*', 'CdkAssetsDockerRole484B6DD3'));
    });
});
class PlainStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        new testutil_1.BucketStack(this, 'Stack');
    }
}
class FileAssetApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        new s3_assets.Asset(stack, 'Asset', {
            path: path.join(__dirname, 'test-file-asset.txt'),
        });
    }
}
class TwoFileAssetsApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        new s3_assets.Asset(stack, 'Asset1', {
            path: path.join(__dirname, 'test-file-asset.txt'),
        });
        new s3_assets.Asset(stack, 'Asset2', {
            path: path.join(__dirname, 'test-file-asset-two.txt'),
        });
    }
}
class DockerAssetApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack = new core_1.Stack(this, 'Stack');
        new ecr_assets.DockerImageAsset(stack, 'Asset', {
            directory: path.join(__dirname, 'test-docker-asset'),
        });
    }
}
function expectedAssetRolePolicy(assumeRolePattern, attachedRole) {
    return {
        PolicyDocument: {
            Statement: [{
                    Action: ['logs:CreateLogGroup', 'logs:CreateLogStream', 'logs:PutLogEvents'],
                    Effect: 'Allow',
                    Resource: {
                        'Fn::Join': ['', [
                                'arn:',
                                { Ref: 'AWS::Partition' },
                                `:logs:${testutil_1.PIPELINE_ENV.region}:${testutil_1.PIPELINE_ENV.account}:log-group:/aws/codebuild/*`,
                            ]],
                    },
                },
                {
                    Action: ['codebuild:CreateReportGroup', 'codebuild:CreateReport', 'codebuild:UpdateReport', 'codebuild:BatchPutTestCases'],
                    Effect: 'Allow',
                    Resource: {
                        'Fn::Join': ['', [
                                'arn:',
                                { Ref: 'AWS::Partition' },
                                `:codebuild:${testutil_1.PIPELINE_ENV.region}:${testutil_1.PIPELINE_ENV.account}:report-group/*`,
                            ]],
                    },
                },
                {
                    Action: ['codebuild:BatchGetBuilds', 'codebuild:StartBuild', 'codebuild:StopBuild'],
                    Effect: 'Allow',
                    Resource: '*',
                },
                {
                    Action: 'sts:AssumeRole',
                    Effect: 'Allow',
                    Resource: assumeRolePattern,
                },
                {
                    Action: ['s3:GetObject*', 's3:GetBucket*', 's3:List*'],
                    Effect: 'Allow',
                    Resource: [
                        { 'Fn::GetAtt': ['CdkPipelineArtifactsBucket7B46C7BF', 'Arn'] },
                        { 'Fn::Join': ['', [{ 'Fn::GetAtt': ['CdkPipelineArtifactsBucket7B46C7BF', 'Arn'] }, '/*']] },
                    ],
                },
                {
                    Action: ['kms:Decrypt', 'kms:DescribeKey'],
                    Effect: 'Allow',
                    Resource: { 'Fn::GetAtt': ['CdkPipelineArtifactsBucketEncryptionKeyDDD3258C', 'Arn'] },
                }],
        },
        Roles: [{ Ref: attachedRole }],
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlwZWxpbmUtYXNzZXRzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwaXBlbGluZS1hc3NldHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRDQUE4RztBQUM5RyxnQ0FBOEI7QUFDOUIsc0RBQXNEO0FBQ3RELG9EQUFvRDtBQUNwRCx3Q0FBb0U7QUFDcEUsNkJBQTZCO0FBRTdCLHlDQUF1RjtBQUV2RixNQUFNLHNCQUFzQixHQUFHLGtFQUFrRSxDQUFDO0FBRWxHLElBQUksR0FBWSxDQUFDO0FBQ2pCLElBQUksYUFBb0IsQ0FBQztBQUN6QixJQUFJLFFBQTBCLENBQUM7QUFFL0IsVUFBVSxDQUFDLEdBQUcsRUFBRTtJQUNkLEdBQUcsR0FBRyxJQUFJLGtCQUFPLEVBQUUsQ0FBQztJQUNwQixhQUFhLEdBQUcsSUFBSSxZQUFLLENBQUMsR0FBRyxFQUFFLGVBQWUsRUFBRSxFQUFFLEdBQUcsRUFBRSx1QkFBWSxFQUFFLENBQUMsQ0FBQztJQUN2RSxRQUFRLEdBQUcsSUFBSSxnQ0FBcUIsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDN0QsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO0lBQ2IsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ2hCLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBSSxDQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRTtJQUM1RCxPQUFPO0lBQ1AsUUFBUSxDQUFDLG1CQUFtQixDQUFDLElBQUksYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRTVELE9BQU87SUFDUCxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsa0JBQWtCLENBQUMsNkJBQTZCLEVBQUU7UUFDdEUsTUFBTSxFQUFFLG9CQUFXLENBQUMsa0JBQVMsQ0FBQyxtQkFBVSxDQUFDO1lBQ3ZDLElBQUksRUFBRSxRQUFRO1NBQ2YsQ0FBQyxDQUFDLENBQUM7S0FDTCxD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QUFJLENBQUMsQ0FBQyxFQUFFO3FCQUM5RjtpQkFDRjtnQkFDRDtvQkFDRSxNQUFNLEVBQUUsQ0FBQyxhQUFhLEVBQUUsaUJBQWlCLENBQUM7b0JBQzFDLE1BQU0sRUFBRSxPQUFPO29CQUNmLFFBQVEsRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLGlEQUFpRCxFQUFFLEtBQUssQ0FBQyxFQUFFO2lCQUN2RixDQUFDO1NBQ0g7UUFDRCxLQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsQ0FBQztLQUMvQixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFycmF5V2l0aCwgZGVlcE9iamVjdExpa2UsIGVuY29kZWRKc29uLCBub3RNYXRjaGluZywgb2JqZWN0TGlrZSwgc3RyaW5nTGlrZSB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydCc7XG5pbXBvcnQgJ0Bhd3MtY2RrL2Fzc2VydC9qZXN0JztcbmltcG9ydCAqIGFzIGVjcl9hc3NldHMgZnJvbSAnQGF3cy1jZGsvYXdzLWVjci1hc3NldHMnO1xuaW1wb3J0ICogYXMgczNfYXNzZXRzIGZyb20gJ0Bhd3MtY2RrL2F3cy1zMy1hc3NldHMnO1xuaW1wb3J0IHsgQ29uc3RydWN0LCBTdGFjaywgU3RhZ2UsIFN0YWdlUHJvcHMgfSBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBjZGtwIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBCdWNrZXRTdGFjaywgUElQRUxJTkVfRU5WLCBUZXN0QXBwLCBUZXN0R2l0SHViTnBtUGlwZWxpbmUgfSBmcm9tICcuL3Rlc3R1dGlsJztcblxuY29uc3QgRklMRV9BU1NFVF9TT1VSQ0VfSEFTSCA9ICc4Mjg5ZmFmNTNjN2RhMzc3YmIyYjkwNjE1OTk5MTcxYWRlZjVlMWQ4ZjZiODg4MTBlNWZlZjc1ZTZjYTA5YmE1JztcblxubGV0IGFwcDogVGVzdEFwcDtcbmxldCBwaXBlbGluZVN0YWNrOiBTdGFjaztcbmxldCBwaXBlbGluZTogY2RrcC5DZGtQaXBlbGluZTtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGFwcCA9IG5ldyBUZXN0QXBwKCk7XG4gIHBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnUGlwZWxpbmVTdGFjaycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gIHBpcGVsaW5lID0gbmV3IFRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG59KTtcblxuYWZ0ZXJFYWNoKCgpID0+IHtcbiAgYXBwLmNsZWFudXAoKTtcbn0pO1xuXG50ZXN0KCdubyBhc3NldHMgc3RhZ2UgaWYgdGhlIGFwcGxpY2F0aW9uIGhhcyBubyBhc3NldHMnLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgUGxhaW5TdGFja0FwcChhcHAsICdBcHAnKSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgU3RhZ2VzOiBub3RNYXRjaGluZyhhcnJheVdpdGgob2JqZWN0TGlrZSh7XG4gICAgICBOYW1lOiAnQXNzZXRzJyxcbiAgICB9KSkpLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjb21tYW5kIGxpbmUgcHJvcGVybHkgbG9jYXRlcyBhc3NldHMgaW4gc3ViYXNzZW1ibHknLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgRmlsZUFzc2V0QXBwKGFwcCwgJ0ZpbGVBc3NldEFwcCcpKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIEVudmlyb25tZW50OiB7XG4gICAgICBJbWFnZTogJ2F3cy9jb2RlYnVpbGQvc3RhbmRhcmQ6NC4wJyxcbiAgICB9LFxuICAgIFNvdXJjZToge1xuICAgICAgQnVpbGRTcGVjOiBlbmNvZGVkSnNvbihkZWVwT2JqZWN0TGlrZSh7XG4gICAgICAgIHBoYXNlczoge1xuICAgICAgICAgIGJ1aWxkOiB7XG4gICAgICAgICAgICBjb21tYW5kczogYXJyYXlXaXRoKGBjZGstYXNzZXRzIC0tcGF0aCBcImFzc2VtYmx5LUZpbGVBc3NldEFwcC9GaWxlQXNzZXRBcHBTdGFja0VBREQ2OEM1LmFzc2V0cy5qc29uXCIgLS12ZXJib3NlIHB1Ymxpc2ggXCIke0ZJTEVfQVNTRVRfU09VUkNFX0hBU0h9OmN1cnJlbnRfYWNjb3VudC1jdXJyZW50X3JlZ2lvblwiYCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdtdWx0aXBsZSBhc3NldHMgYXJlIHB1Ymxpc2hlZCBpbiBwYXJhbGxlbCcsICgpID0+IHtcbiAgLy8gV0hFTlxuICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBUd29GaWxlQXNzZXRzQXBwKGFwcCwgJ0ZpbGVBc3NldEFwcCcpKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZScsIHtcbiAgICBTdGFnZXM6IGFycmF5V2l0aCh7XG4gICAgICBOYW1lOiAnQXNzZXRzJyxcbiAgICAgIEFjdGlvbnM6IFtcbiAgICAgICAgb2JqZWN0TGlrZSh7IFJ1bk9yZGVyOiAxIH0pLFxuICAgICAgICBvYmplY3RMaWtlKHsgUnVuT3JkZXI6IDEgfSksXG4gICAgICBdLFxuICAgIH0pLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdhc3NldHMgYXJlIGFsc28gcHVibGlzaGVkIHdoZW4gdXNpbmcgdGhlIGxvd2VyLWxldmVsIGFkZFN0YWNrQXJ0aWZhY3REZXBsb3ltZW50JywgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCBhc20gPSBuZXcgRmlsZUFzc2V0QXBwKGFwcCwgJ0ZpbGVBc3NldEFwcCcpLnN5bnRoKCk7XG5cbiAgLy8gV0hFTlxuICBwaXBlbGluZS5hZGRTdGFnZSgnU29tZVN0YWdlJykuYWRkU3RhY2tBcnRpZmFjdERlcGxveW1lbnQoYXNtLmdldFN0YWNrQnlOYW1lKCdGaWxlQXNzZXRBcHAtU3RhY2snKSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgU3RhZ2VzOiBhcnJheVdpdGgoe1xuICAgICAgTmFtZTogJ0Fzc2V0cycsXG4gICAgICBBY3Rpb25zOiBbXG4gICAgICAgIG9iamVjdExpa2Uoe1xuICAgICAgICAgIE5hbWU6ICdGaWxlQXNzZXQxJyxcbiAgICAgICAgICBSdW5PcmRlcjogMSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgIH0pLFxuICB9KTtcbn0pO1xuXG50ZXN0KCdmaWxlIGltYWdlIGFzc2V0IHB1Ymxpc2hlcnMgZG8gbm90IHVzZSBwcml2aWxlZ2VkbW9kZSwgaGF2ZSByaWdodCBBc3N1bWVSb2xlJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IEZpbGVBc3NldEFwcChhcHAsICdGaWxlQXNzZXRBcHAnKSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBTb3VyY2U6IHtcbiAgICAgIEJ1aWxkU3BlYzogZW5jb2RlZEpzb24oZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgY29tbWFuZHM6IGFycmF5V2l0aChzdHJpbmdMaWtlKCdjZGstYXNzZXRzIConKSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pKSxcbiAgICB9LFxuICAgIEVudmlyb25tZW50OiBvYmplY3RMaWtlKHtcbiAgICAgIFByaXZpbGVnZWRNb2RlOiBmYWxzZSxcbiAgICAgIEltYWdlOiAnYXdzL2NvZGVidWlsZC9zdGFuZGFyZDo0LjAnLFxuICAgIH0pLFxuICB9KTtcblxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICBTdGF0ZW1lbnQ6IGFycmF5V2l0aCh7XG4gICAgICAgIEFjdGlvbjogJ3N0czpBc3N1bWVSb2xlJyxcbiAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICBSZXNvdXJjZTogJ2FybjoqOmlhbTo6Kjpyb2xlLyotZmlsZS1wdWJsaXNoaW5nLXJvbGUtKicsXG4gICAgICB9KSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdkb2NrZXIgaW1hZ2UgYXNzZXQgcHVibGlzaGVycyB1c2UgcHJpdmlsZWdlZG1vZGUsIGhhdmUgcmlnaHQgQXNzdW1lUm9sZScsICgpID0+IHtcbiAgLy8gV0hFTlxuICBwaXBlbGluZS5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBEb2NrZXJBc3NldEFwcChhcHAsICdEb2NrZXJBc3NldEFwcCcpKTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6Q29kZUJ1aWxkOjpQcm9qZWN0Jywge1xuICAgIFNvdXJjZToge1xuICAgICAgQnVpbGRTcGVjOiBlbmNvZGVkSnNvbihkZWVwT2JqZWN0TGlrZSh7XG4gICAgICAgIHBoYXNlczoge1xuICAgICAgICAgIGJ1aWxkOiB7XG4gICAgICAgICAgICBjb21tYW5kczogYXJyYXlXaXRoKHN0cmluZ0xpa2UoJ2Nkay1hc3NldHMgKicpKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSkpLFxuICAgIH0sXG4gICAgRW52aXJvbm1lbnQ6IG9iamVjdExpa2Uoe1xuICAgICAgSW1hZ2U6ICdhd3MvY29kZWJ1aWxkL3N0YW5kYXJkOjQuMCcsXG4gICAgICBQcml2aWxlZ2VkTW9kZTogdHJ1ZSxcbiAgICB9KSxcbiAgfSk7XG4gIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6SUFNOjpQb2xpY3knLCB7XG4gICAgUG9saWN5RG9jdW1lbnQ6IHtcbiAgICAgIFN0YXRlbWVudDogYXJyYXlXaXRoKHtcbiAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgIFJlc291cmNlOiAnYXJuOio6aWFtOjoqOnJvbGUvKi1pbWFnZS1wdWJsaXNoaW5nLXJvbGUtKicsXG4gICAgICB9KSxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdjYW4gY29udHJvbCBmaXgvQ0xJIHZlcnNpb24gdXNlZCBpbiBwaXBlbGluZSBzZWxmdXBkYXRlJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IHN0YWNrMiA9IG5ldyBTdGFjayhhcHAsICdTdGFjazInLCB7IGVudjogUElQRUxJTkVfRU5WIH0pO1xuICBjb25zdCBwaXBlbGluZTIgPSBuZXcgVGVzdEdpdEh1Yk5wbVBpcGVsaW5lKHN0YWNrMiwgJ0NkazInLCB7XG4gICAgY2RrQ2xpVmVyc2lvbjogJzEuMi4zJyxcbiAgfSk7XG4gIHBpcGVsaW5lMi5hZGRBcHBsaWNhdGlvblN0YWdlKG5ldyBGaWxlQXNzZXRBcHAoc3RhY2syLCAnRmlsZUFzc2V0QXBwJykpO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHN0YWNrMikudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVCdWlsZDo6UHJvamVjdCcsIHtcbiAgICBFbnZpcm9ubWVudDoge1xuICAgICAgSW1hZ2U6ICdhd3MvY29kZWJ1aWxkL3N0YW5kYXJkOjQuMCcsXG4gICAgfSxcbiAgICBTb3VyY2U6IHtcbiAgICAgIEJ1aWxkU3BlYzogZW5jb2RlZEpzb24oZGVlcE9iamVjdExpa2Uoe1xuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBpbnN0YWxsOiB7XG4gICAgICAgICAgICBjb21tYW5kczogJ25wbSBpbnN0YWxsIC1nIGNkay1hc3NldHNAMS4yLjMnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KSksXG4gICAgfSxcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2Fzc2V0IHJvbGVzIGFuZCBwb2xpY2llcycsICgpID0+IHtcbiAgdGVzdCgnaW5jbHVkZXMgZmlsZSBwdWJsaXNoaW5nIGFzc2V0cyByb2xlIGZvciBhcHBzIHdpdGggZmlsZSBhc3NldHMnLCAoKSA9PiB7XG4gICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgRmlsZUFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG5cbiAgICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OklBTTo6Um9sZScsIHtcbiAgICAgIEFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IFt7XG4gICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBQcmluY2lwYWw6IHtcbiAgICAgICAgICAgIFNlcnZpY2U6ICdjb2RlYnVpbGQuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAgICBBV1M6IHtcbiAgICAgICAgICAgICAgJ0ZuOjpKb2luJzogWycnLCBbXG4gICAgICAgICAgICAgICAgJ2FybjonLCB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LCBgOmlhbTo6JHtQSVBFTElORV9FTlYuYWNjb3VudH06cm9vdGAsXG4gICAgICAgICAgICAgIF1dLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpJQU06OlBvbGljeScsXG4gICAgICBleHBlY3RlZEFzc2V0Um9sZVBvbGljeSgnYXJuOio6aWFtOjoqOnJvbGUvKi1maWxlLXB1Ymxpc2hpbmctcm9sZS0qJywgJ0Nka0Fzc2V0c0ZpbGVSb2xlNkJFMTdBMDcnKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2luY2x1ZGVzIGltYWdlIHB1Ymxpc2hpbmcgYXNzZXRzIHJvbGUgZm9yIGFwcHMgd2l0aCBEb2NrZXIgYXNzZXRzJywgKCkgPT4ge1xuICAgIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IERvY2tlckFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG5cbiAgICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OklBTTo6Um9sZScsIHtcbiAgICAgIEFzc3VtZVJvbGVQb2xpY3lEb2N1bWVudDoge1xuICAgICAgICBTdGF0ZW1lbnQ6IFt7XG4gICAgICAgICAgQWN0aW9uOiAnc3RzOkFzc3VtZVJvbGUnLFxuICAgICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgICBQcmluY2lwYWw6IHtcbiAgICAgICAgICAgIFNlcnZpY2U6ICdjb2RlYnVpbGQuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAgICBBV1M6IHtcbiAgICAgICAgICAgICAgJ0ZuOjpKb2luJzogWycnLCBbXG4gICAgICAgICAgICAgICAgJ2FybjonLCB7IFJlZjogJ0FXUzo6UGFydGl0aW9uJyB9LCBgOmlhbTo6JHtQSVBFTElORV9FTlYuYWNjb3VudH06cm9vdGAsXG4gICAgICAgICAgICAgIF1dLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XSxcbiAgICAgIH0sXG4gICAgfSk7XG4gICAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpJQU06OlBvbGljeScsXG4gICAgICBleHBlY3RlZEFzc2V0Um9sZVBvbGljeSgnYXJuOio6aWFtOjoqOnJvbGUvKi1pbWFnZS1wdWJsaXNoaW5nLXJvbGUtKicsICdDZGtBc3NldHNEb2NrZXJSb2xlNDg0QjZERDMnKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2luY2x1ZGVzIGJvdGggcm9sZXMgZm9yIGFwcHMgd2l0aCBib3RoIGZpbGUgYW5kIERvY2tlciBhc3NldHMnLCAoKSA9PiB7XG4gICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgRmlsZUFzc2V0QXBwKGFwcCwgJ0FwcDEnKSk7XG4gICAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgRG9ja2VyQXNzZXRBcHAoYXBwLCAnQXBwMicpKTtcblxuICAgIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6SUFNOjpQb2xpY3knLFxuICAgICAgZXhwZWN0ZWRBc3NldFJvbGVQb2xpY3koJ2FybjoqOmlhbTo6Kjpyb2xlLyotZmlsZS1wdWJsaXNoaW5nLXJvbGUtKicsICdDZGtBc3NldHNGaWxlUm9sZTZCRTE3QTA3JykpO1xuICAgIGV4cGVjdChwaXBlbGluZVN0YWNrKS50b0hhdmVSZXNvdXJjZUxpa2UoJ0FXUzo6SUFNOjpQb2xpY3knLFxuICAgICAgZXhwZWN0ZWRBc3NldFJvbGVQb2xpY3koJ2FybjoqOmlhbTo6Kjpyb2xlLyotaW1hZ2UtcHVibGlzaGluZy1yb2xlLSonLCAnQ2RrQXNzZXRzRG9ja2VyUm9sZTQ4NEI2REQzJykpO1xuICB9KTtcbn0pO1xuXG5jbGFzcyBQbGFpblN0YWNrQXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrJyk7XG4gIH1cbn1cblxuY2xhc3MgRmlsZUFzc2V0QXBwIGV4dGVuZHMgU3RhZ2Uge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IFN0YWdlUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBjb25zdCBzdGFjayA9IG5ldyBTdGFjayh0aGlzLCAnU3RhY2snKTtcbiAgICBuZXcgczNfYXNzZXRzLkFzc2V0KHN0YWNrLCAnQXNzZXQnLCB7XG4gICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdC1maWxlLWFzc2V0LnR4dCcpLFxuICAgIH0pO1xuICB9XG59XG5cbmNsYXNzIFR3b0ZpbGVBc3NldHNBcHAgZXh0ZW5kcyBTdGFnZSB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhZ2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKHRoaXMsICdTdGFjaycpO1xuICAgIG5ldyBzM19hc3NldHMuQXNzZXQoc3RhY2ssICdBc3NldDEnLCB7XG4gICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdC1maWxlLWFzc2V0LnR4dCcpLFxuICAgIH0pO1xuICAgIG5ldyBzM19hc3NldHMuQXNzZXQoc3RhY2ssICdBc3NldDInLCB7XG4gICAgICBwYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdC1maWxlLWFzc2V0LXR3by50eHQnKSxcbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBEb2NrZXJBc3NldEFwcCBleHRlbmRzIFN0YWdlIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBTdGFnZVByb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2sodGhpcywgJ1N0YWNrJyk7XG4gICAgbmV3IGVjcl9hc3NldHMuRG9ja2VySW1hZ2VBc3NldChzdGFjaywgJ0Fzc2V0Jywge1xuICAgICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdC1kb2NrZXItYXNzZXQnKSxcbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBleHBlY3RlZEFzc2V0Um9sZVBvbGljeShhc3N1bWVSb2xlUGF0dGVybjogc3RyaW5nLCBhdHRhY2hlZFJvbGU6IHN0cmluZykge1xuICByZXR1cm4ge1xuICAgIFBvbGljeURvY3VtZW50OiB7XG4gICAgICBTdGF0ZW1lbnQ6IFt7XG4gICAgICAgIEFjdGlvbjogWydsb2dzOkNyZWF0ZUxvZ0dyb3VwJywgJ2xvZ3M6Q3JlYXRlTG9nU3RyZWFtJywgJ2xvZ3M6UHV0TG9nRXZlbnRzJ10sXG4gICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgUmVzb3VyY2U6IHtcbiAgICAgICAgICAnRm46OkpvaW4nOiBbJycsIFtcbiAgICAgICAgICAgICdhcm46JyxcbiAgICAgICAgICAgIHsgUmVmOiAnQVdTOjpQYXJ0aXRpb24nIH0sXG4gICAgICAgICAgICBgOmxvZ3M6JHtQSVBFTElORV9FTlYucmVnaW9ufToke1BJUEVMSU5FX0VOVi5hY2NvdW50fTpsb2ctZ3JvdXA6L2F3cy9jb2RlYnVpbGQvKmAsXG4gICAgICAgICAgXV0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBBY3Rpb246IFsnY29kZWJ1aWxkOkNyZWF0ZVJlcG9ydEdyb3VwJywgJ2NvZGVidWlsZDpDcmVhdGVSZXBvcnQnLCAnY29kZWJ1aWxkOlVwZGF0ZVJlcG9ydCcsICdjb2RlYnVpbGQ6QmF0Y2hQdXRUZXN0Q2FzZXMnXSxcbiAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICBSZXNvdXJjZToge1xuICAgICAgICAgICdGbjo6Sm9pbic6IFsnJywgW1xuICAgICAgICAgICAgJ2FybjonLFxuICAgICAgICAgICAgeyBSZWY6ICdBV1M6OlBhcnRpdGlvbicgfSxcbiAgICAgICAgICAgIGA6Y29kZWJ1aWxkOiR7UElQRUxJTkVfRU5WLnJlZ2lvbn06JHtQSVBFTElORV9FTlYuYWNjb3VudH06cmVwb3J0LWdyb3VwLypgLFxuICAgICAgICAgIF1dLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgQWN0aW9uOiBbJ2NvZGVidWlsZDpCYXRjaEdldEJ1aWxkcycsICdjb2RlYnVpbGQ6U3RhcnRCdWlsZCcsICdjb2RlYnVpbGQ6U3RvcEJ1aWxkJ10sXG4gICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgUmVzb3VyY2U6ICcqJyxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIEFjdGlvbjogJ3N0czpBc3N1bWVSb2xlJyxcbiAgICAgICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgICAgICBSZXNvdXJjZTogYXNzdW1lUm9sZVBhdHRlcm4sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBBY3Rpb246IFsnczM6R2V0T2JqZWN0KicsICdzMzpHZXRCdWNrZXQqJywgJ3MzOkxpc3QqJ10sXG4gICAgICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICAgICAgUmVzb3VyY2U6IFtcbiAgICAgICAgICB7ICdGbjo6R2V0QXR0JzogWydDZGtQaXBlbGluZUFydGlmYWN0c0J1Y2tldDdCNDZDN0JGJywgJ0FybiddIH0sXG4gICAgICAgICAgeyAnRm46OkpvaW4nOiBbJycsIFt7ICdGbjo6R2V0QXR0JzogWydDZGtQaXBlbGluZUFydGlmYWN0c0J1Y2tldDdCNDZDN0JGJywgJ0FybiddIH0sICcvKiddXSB9LFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgQWN0aW9uOiBbJ2ttczpEZWNyeXB0JywgJ2ttczpEZXNjcmliZUtleSddLFxuICAgICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICAgIFJlc291cmNlOiB7ICdGbjo6R2V0QXR0JzogWydDZGtQaXBlbGluZUFydGlmYWN0c0J1Y2tldEVuY3J5cHRpb25LZXlEREQzMjU4QycsICdBcm4nXSB9LFxuICAgICAgfV0sXG4gICAgfSxcbiAgICBSb2xlczogW3sgUmVmOiBhdHRhY2hlZFJvbGUgfV0sXG4gIH07XG59XG4iXX0=