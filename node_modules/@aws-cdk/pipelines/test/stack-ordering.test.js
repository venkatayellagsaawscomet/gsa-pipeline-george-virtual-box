"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assert_1 = require("@aws-cdk/assert");
require("@aws-cdk/assert/jest");
const core_1 = require("@aws-cdk/core");
const testmatchers_1 = require("./testmatchers");
const testutil_1 = require("./testutil");
let app;
let pipelineStack;
let pipeline;
beforeEach(() => {
    app = new testutil_1.TestApp();
    pipelineStack = new core_1.Stack(app, 'PipelineStack', { env: testutil_1.PIPELINE_ENV });
    pipeline = new testutil_1.TestGitHubNpmPipeline(pipelineStack, 'Cdk');
});
test('interdependent stacks are in the right order', () => {
    // WHEN
    pipeline.addApplicationStage(new TwoStackApp(app, 'MyApp'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'MyApp',
            Actions: testmatchers_1.sortedByRunOrder([
                assert_1.objectLike({ Name: 'Stack1.Prepare' }),
                assert_1.objectLike({ Name: 'Stack1.Deploy' }),
                assert_1.objectLike({ Name: 'Stack2.Prepare' }),
                assert_1.objectLike({ Name: 'Stack2.Deploy' }),
            ]),
        }),
    });
});
test('multiple independent stacks go in parallel', () => {
    // WHEN
    pipeline.addApplicationStage(new ThreeStackApp(app, 'MyApp'));
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'MyApp',
            Actions: testmatchers_1.sortedByRunOrder([
                // 1 and 2 in parallel
                assert_1.objectLike({ Name: 'Stack1.Prepare' }),
                assert_1.objectLike({ Name: 'Stack2.Prepare' }),
                assert_1.objectLike({ Name: 'Stack1.Deploy' }),
                assert_1.objectLike({ Name: 'Stack2.Deploy' }),
                // Then 3
                assert_1.objectLike({ Name: 'Stack3.Prepare' }),
                assert_1.objectLike({ Name: 'Stack3.Deploy' }),
            ]),
        }),
    });
});
test('manual approval is inserted in correct location', () => {
    // WHEN
    pipeline.addApplicationStage(new TwoStackApp(app, 'MyApp'), {
        manualApprovals: true,
    });
    // THEN
    expect(pipelineStack).toHaveResourceLike('AWS::CodePipeline::Pipeline', {
        Stages: assert_1.arrayWith({
            Name: 'MyApp',
            Actions: testmatchers_1.sortedByRunOrder([
                assert_1.objectLike({ Name: 'Stack1.Prepare' }),
                assert_1.objectLike({ Name: 'ManualApproval' }),
                assert_1.objectLike({ Name: 'Stack1.Deploy' }),
                assert_1.objectLike({ Name: 'Stack2.Prepare' }),
                assert_1.objectLike({ Name: 'ManualApproval2' }),
                assert_1.objectLike({ Name: 'Stack2.Deploy' }),
            ]),
        }),
    });
});
class TwoStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack2 = new testutil_1.BucketStack(this, 'Stack2');
        const stack1 = new testutil_1.BucketStack(this, 'Stack1');
        stack2.addDependency(stack1);
    }
}
/**
 * Three stacks where the last one depends on the earlier 2
 */
class ThreeStackApp extends core_1.Stage {
    constructor(scope, id, props) {
        super(scope, id, props);
        const stack1 = new testutil_1.BucketStack(this, 'Stack1');
        const stack2 = new testutil_1.BucketStack(this, 'Stack2');
        const stack3 = new testutil_1.BucketStack(this, 'Stack3');
        stack3.addDependency(stack1);
        stack3.addDependency(stack2);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2stb3JkZXJpbmcudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YWNrLW9yZGVyaW5nLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw0Q0FBd0Q7QUFDeEQsZ0NBQThCO0FBQzlCLHdDQUF5RTtBQUV6RSxpREFBa0Q7QUFDbEQseUNBQXVGO0FBRXZGLElBQUksR0FBUSxDQUFDO0FBQ2IsSUFBSSxhQUFvQixDQUFDO0FBQ3pCLElBQUksUUFBMEIsQ0FBQztBQUUvQixVQUFVLENBQUMsR0FBRyxFQUFFO0lBQ2QsR0FBRyxHQUFHLElBQUksa0JBQU8sRUFBRSxDQUFDO0lBQ3BCLGFBQWEsR0FBRyxJQUFJLFlBQUssQ0FBQyxHQUFHLEVBQUUsZUFBZSxFQUFFLEVBQUUsR0FBRyxFQUFFLHVCQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZFLFFBQVEsR0FBRyxJQUFJLGdDQUFxQixDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3RCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyw4Q0FBOEMsRUFBRSxHQUFHLEVBQUU7SUFDeEQsT0FBTztJQUNQLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUU1RCxPQUFPO0lBQ1AsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLDZCQUE2QixFQUFFO1FBQ3RFLE1BQU0sRUFBRSxrQkFBUyxDQUFDO1lBQ2hCLElBQUksRUFBRSxPQUFPO1lBQ2IsT0FBTyxFQUFFLCtCQUFnQixDQUFDO2dCQUN4QixtQkFBVSxDQUFDLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLENBQUM7Z0JBQ3RDLG1CQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLENBQUM7Z0JBQ3JDLG1CQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQztnQkFDdEMsbUJBQVUs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TUFBTSxHQUFHLElBQUksc0JBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDL0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxzQkFBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLHNCQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0IsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhcnJheVdpdGgsIG9iamVjdExpa2UgfSBmcm9tICdAYXdzLWNkay9hc3NlcnQnO1xuaW1wb3J0ICdAYXdzLWNkay9hc3NlcnQvamVzdCc7XG5pbXBvcnQgeyBBcHAsIENvbnN0cnVjdCwgU3RhY2ssIFN0YWdlLCBTdGFnZVByb3BzIH0gZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgKiBhcyBjZGtwIGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBzb3J0ZWRCeVJ1bk9yZGVyIH0gZnJvbSAnLi90ZXN0bWF0Y2hlcnMnO1xuaW1wb3J0IHsgQnVja2V0U3RhY2ssIFBJUEVMSU5FX0VOViwgVGVzdEFwcCwgVGVzdEdpdEh1Yk5wbVBpcGVsaW5lIH0gZnJvbSAnLi90ZXN0dXRpbCc7XG5cbmxldCBhcHA6IEFwcDtcbmxldCBwaXBlbGluZVN0YWNrOiBTdGFjaztcbmxldCBwaXBlbGluZTogY2RrcC5DZGtQaXBlbGluZTtcblxuYmVmb3JlRWFjaCgoKSA9PiB7XG4gIGFwcCA9IG5ldyBUZXN0QXBwKCk7XG4gIHBpcGVsaW5lU3RhY2sgPSBuZXcgU3RhY2soYXBwLCAnUGlwZWxpbmVTdGFjaycsIHsgZW52OiBQSVBFTElORV9FTlYgfSk7XG4gIHBpcGVsaW5lID0gbmV3IFRlc3RHaXRIdWJOcG1QaXBlbGluZShwaXBlbGluZVN0YWNrLCAnQ2RrJyk7XG59KTtcblxudGVzdCgnaW50ZXJkZXBlbmRlbnQgc3RhY2tzIGFyZSBpbiB0aGUgcmlnaHQgb3JkZXInLCAoKSA9PiB7XG4gIC8vIFdIRU5cbiAgcGlwZWxpbmUuYWRkQXBwbGljYXRpb25TdGFnZShuZXcgVHdvU3RhY2tBcHAoYXBwLCAnTXlBcHAnKSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgU3RhZ2VzOiBhcnJheVdpdGgoe1xuICAgICAgTmFtZTogJ015QXBwJyxcbiAgICAgIEFjdGlvbnM6IHNvcnRlZEJ5UnVuT3JkZXIoW1xuICAgICAgICBvYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMS5QcmVwYXJlJyB9KSxcbiAgICAgICAgb2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazEuRGVwbG95JyB9KSxcbiAgICAgICAgb2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazIuUHJlcGFyZScgfSksXG4gICAgICAgIG9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2syLkRlcGxveScgfSksXG4gICAgICBdKSxcbiAgICB9KSxcbiAgfSk7XG59KTtcblxudGVzdCgnbXVsdGlwbGUgaW5kZXBlbmRlbnQgc3RhY2tzIGdvIGluIHBhcmFsbGVsJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IFRocmVlU3RhY2tBcHAoYXBwLCAnTXlBcHAnKSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGlwZWxpbmVTdGFjaykudG9IYXZlUmVzb3VyY2VMaWtlKCdBV1M6OkNvZGVQaXBlbGluZTo6UGlwZWxpbmUnLCB7XG4gICAgU3RhZ2VzOiBhcnJheVdpdGgoe1xuICAgICAgTmFtZTogJ015QXBwJyxcbiAgICAgIEFjdGlvbnM6IHNvcnRlZEJ5UnVuT3JkZXIoW1xuICAgICAgICAvLyAxIGFuZCAyIGluIHBhcmFsbGVsXG4gICAgICAgIG9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2sxLlByZXBhcmUnIH0pLFxuICAgICAgICBvYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMi5QcmVwYXJlJyB9KSxcbiAgICAgICAgb2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazEuRGVwbG95JyB9KSxcbiAgICAgICAgb2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazIuRGVwbG95JyB9KSxcbiAgICAgICAgLy8gVGhlbiAzXG4gICAgICAgIG9iamVjdExpa2UoeyBOYW1lOiAnU3RhY2szLlByZXBhcmUnIH0pLFxuICAgICAgICBvYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMy5EZXBsb3knIH0pLFxuICAgICAgXSksXG4gICAgfSksXG4gIH0pO1xufSk7XG5cbnRlc3QoJ21hbnVhbCBhcHByb3ZhbCBpcyBpbnNlcnRlZCBpbiBjb3JyZWN0IGxvY2F0aW9uJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIHBpcGVsaW5lLmFkZEFwcGxpY2F0aW9uU3RhZ2UobmV3IFR3b1N0YWNrQXBwKGFwcCwgJ015QXBwJyksIHtcbiAgICBtYW51YWxBcHByb3ZhbHM6IHRydWUsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBpcGVsaW5lU3RhY2spLnRvSGF2ZVJlc291cmNlTGlrZSgnQVdTOjpDb2RlUGlwZWxpbmU6OlBpcGVsaW5lJywge1xuICAgIFN0YWdlczogYXJyYXlXaXRoKHtcbiAgICAgIE5hbWU6ICdNeUFwcCcsXG4gICAgICBBY3Rpb25zOiBzb3J0ZWRCeVJ1bk9yZGVyKFtcbiAgICAgICAgb2JqZWN0TGlrZSh7IE5hbWU6ICdTdGFjazEuUHJlcGFyZScgfSksXG4gICAgICAgIG9iamVjdExpa2UoeyBOYW1lOiAnTWFudWFsQXBwcm92YWwnIH0pLFxuICAgICAgICBvYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMS5EZXBsb3knIH0pLFxuICAgICAgICBvYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMi5QcmVwYXJlJyB9KSxcbiAgICAgICAgb2JqZWN0TGlrZSh7IE5hbWU6ICdNYW51YWxBcHByb3ZhbDInIH0pLFxuICAgICAgICBvYmplY3RMaWtlKHsgTmFtZTogJ1N0YWNrMi5EZXBsb3knIH0pLFxuICAgICAgXSksXG4gICAgfSksXG4gIH0pO1xufSk7XG5cblxuY2xhc3MgVHdvU3RhY2tBcHAgZXh0ZW5kcyBTdGFnZSB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhZ2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgY29uc3Qgc3RhY2syID0gbmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjazInKTtcbiAgICBjb25zdCBzdGFjazEgPSBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrMScpO1xuXG4gICAgc3RhY2syLmFkZERlcGVuZGVuY3koc3RhY2sxKTtcbiAgfVxufVxuXG4vKipcbiAqIFRocmVlIHN0YWNrcyB3aGVyZSB0aGUgbGFzdCBvbmUgZGVwZW5kcyBvbiB0aGUgZWFybGllciAyXG4gKi9cbmNsYXNzIFRocmVlU3RhY2tBcHAgZXh0ZW5kcyBTdGFnZSB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhZ2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgY29uc3Qgc3RhY2sxID0gbmV3IEJ1Y2tldFN0YWNrKHRoaXMsICdTdGFjazEnKTtcbiAgICBjb25zdCBzdGFjazIgPSBuZXcgQnVja2V0U3RhY2sodGhpcywgJ1N0YWNrMicpO1xuICAgIGNvbnN0IHN0YWNrMyA9IG5ldyBCdWNrZXRTdGFjayh0aGlzLCAnU3RhY2szJyk7XG5cbiAgICBzdGFjazMuYWRkRGVwZW5kZW5jeShzdGFjazEpO1xuICAgIHN0YWNrMy5hZGREZXBlbmRlbmN5KHN0YWNrMik7XG4gIH1cbn1cbiJdfQ==