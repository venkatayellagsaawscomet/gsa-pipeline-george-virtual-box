"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable max-len */
/* eslint-disable no-console */
/* eslint-disable @typescript-eslint/no-require-imports */
const cfnResponse = require("../../lib/provider-framework/runtime/cfn-response");
const framework = require("../../lib/provider-framework/runtime/framework");
const outbound = require("../../lib/provider-framework/runtime/outbound");
const mocks = require("./mocks");
console.log = jest.fn();
cfnResponse.includeStackTraces = false;
const MOCK_PHYSICAL_ID = 'mock-physical-resource-id';
const MOCK_PROPS = { Name: 'Value', List: ['1', '2', '3'], ServiceToken: 'bla' };
const MOCK_ATTRS = { MyAttribute: 'my-mock-attribute' };
outbound.httpRequest = mocks.httpRequestMock;
outbound.invokeFunction = mocks.invokeFunctionMock;
outbound.startExecution = mocks.startExecutionMock;
beforeEach(() => mocks.setup());
test('async flow: isComplete returns true only after 3 times', async () => {
    let isCompleteCalls = 0;
    mocks.onEventImplMock = async (event) => {
        expect(event.RequestType).toEqual('Create');
        expect(event.ResourceProperties).toStrictEqual(MOCK_PROPS);
        expect(event.PhysicalResourceId).toBeUndefined(); // physical ID in CREATE
        return {
            PhysicalResourceId: MOCK_PHYSICAL_ID,
            Data: MOCK_ATTRS,
            ArbitraryField: 1234,
        };
    };
    mocks.isCompleteImplMock = async (event) => {
        isCompleteCalls++;
        expect(event.ArbitraryField).toEqual(1234); // any field is passed through
        expect(event.PhysicalResourceId).toEqual(MOCK_PHYSICAL_ID); // physical ID returned from onEvent is passed to "isComplete"
        expect(event.Data).toStrictEqual(MOCK_ATTRS); // attributes are propagated between the calls
        const result = isCompleteCalls === 3;
        if (!result) {
            return {
                IsComplete: false,
            };
        }
        return {
            IsComplete: true,
            Data: {
                Additional: 'attribute',
            },
        };
    };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS,
    });
    // THEN
    expect(isCompleteCalls).toEqual(3);
    expectCloudFormationSuccess({
        PhysicalResourceId: MOCK_PHYSICAL_ID,
        Data: {
            ...MOCK_ATTRS,
            Additional: 'attribute',
        },
    });
});
test('isComplete throws in the first invocation', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => { throw new Error('Some failure'); };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS,
    });
    expectCloudFormationFailed('Some failure\n\nLogs: /aws/lambda/complete\n');
});
test('fails gracefully if "onEvent" throws an error', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => { throw new Error('error thrown during onEvent'); };
    mocks.isCompleteImplMock = async () => ({ IsComplete: true });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectCloudFormationFailed('error thrown during onEvent\n\nLogs: /aws/lambda/event\n');
    expectNoWaiter();
});
describe('PhysicalResourceId', () => {
    describe('if not omitted from onEvent result', () => {
        it('defaults to RequestId for CREATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Create',
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: mocks.MOCK_REQUEST.RequestId,
            });
        });
        it('defaults to the current PhysicalResourceId for UPDATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Update',
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
        });
        it('defaults to the current PhysicalResourceId for DELETE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Delete',
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
        });
    });
    test('UPDATE: can change the physical ID by returning a new ID', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Update',
            PhysicalResourceId: 'CurrentPhysicalId',
        });
        // THEN
        expectCloudFormationSuccess({
            PhysicalResourceId: 'NewPhysicalId',
        });
    });
    test('DELETE: cannot change the physical resource ID during a delete', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: 'CurrentPhysicalId',
        });
        // THEN
        expectNoWaiter();
        expectCloudFormationFailed('DELETE: cannot change the physical resource ID from "CurrentPhysicalId" to "NewPhysicalId" during deletion');
    });
});
test('isComplete always returns "false" and then a timeout occurs', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID,
    });
    // THEN
    expectCloudFormationFailed('Operation timed out');
});
test('isComplete: "Data" is not allowed if InComplete is "False"', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false, Data: { Foo: 3333 } });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID,
    });
    expectCloudFormationFailed('"Data" is not allowed if "IsComplete" is "False"');
});
test('if there is no user-defined "isComplete", the waiter will not be triggered or needed', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectNoWaiter();
    expectCloudFormationSuccess({ PhysicalResourceId: MOCK_PHYSICAL_ID });
});
test('fails if user handler returns a non-object response', async () => {
    // GIVEN
    mocks.stringifyPayload = false;
    mocks.onEventImplMock = async () => 'string';
    // WHEN
    await simulateEvent({ RequestType: 'Create' });
    // THEN
    expectCloudFormationFailed('return values from user-handlers must be JSON objects. got: \"string\"');
});
describe('if CREATE fails, the subsequent DELETE will be ignored', () => {
    it('FAILED response sets PhysicalResourceId to a special marker', async () => {
        // WHEN
        mocks.onEventImplMock = async () => { throw new Error('CREATE FAILED'); };
        // THEN
        await simulateEvent({
            RequestType: 'Create',
        });
        expectCloudFormationFailed('CREATE FAILED\n\nLogs: /aws/lambda/event\n', {
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
    });
    it('DELETE request with the marker succeeds without calling user handler', async () => {
        // GIVEN
        // user handler is not assigned
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
        // THEN
        expectCloudFormationSuccess();
    });
});
// -----------------------------------------------------------------------------------------------------------------------
/**
 * Triggers the custom resource lifecycle event flow by invoking the framework's
 * onEvent function and then, if the waiter state machine was started, simulates
 * the waiter and invokes isComplete and onTimeout as appropriate.
 */
async function simulateEvent(req) {
    const x = {
        ServiceToken: 'SERVICE-TOKEN',
        ResponseURL: mocks.MOCK_REQUEST.ResponseURL,
        StackId: mocks.MOCK_REQUEST.StackId,
        RequestId: mocks.MOCK_REQUEST.RequestId,
        ResourceType: 'Custom::TestResource',
        LogicalResourceId: mocks.MOCK_REQUEST.LogicalResourceId,
        ...req,
    };
    mocks.prepareForExecution();
    await framework.onEvent(x);
    // if the FSM
    if (mocks.startStateMachineInput && mocks.startStateMachineInput.stateMachineArn === mocks.MOCK_SFN_ARN) {
        await simulateWaiter(JSON.parse(mocks.startStateMachineInput.input));
    }
    async function simulateWaiter(event) {
        let retry = true;
        let count = 5;
        while (retry) {
            try {
                await framework.isComplete(event);
                retry = false;
            }
            catch (e) {
                if (e instanceof cfnResponse.Retry) {
                    if (count-- === 0) {
                        await framework.onTimeout({ Cause: JSON.stringify({ errorMessage: e.message }) });
                        retry = false;
                    }
                    else {
                        retry = true;
                        continue;
                    }
                }
                else {
                    throw new Error(e);
                }
            }
        }
    }
}
function expectCloudFormationFailed(expectedReason, resp) {
    expectCloudFormationResponse({
        Status: 'FAILED',
        Reason: expectedReason,
        ...resp,
    });
}
function expectCloudFormationSuccess(resp) {
    if (mocks.cfnResponse.Status !== 'SUCCESS') {
        console.error(mocks.cfnResponse.Reason || '<NO REASON>');
    }
    expectCloudFormationResponse({ Status: 'SUCCESS', ...resp });
}
function expectCloudFormationResponse(resp = {}) {
    for (const [key, expected] of Object.entries(resp)) {
        const actual = mocks.cfnResponse[key];
        expect(actual).toStrictEqual(expected);
    }
}
function expectNoWaiter() {
    expect(mocks.startStateMachineInput).toBeUndefined();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicnVudGltZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLCtCQUErQjtBQUMvQiwwREFBMEQ7QUFDMUQsaUZBQWtGO0FBQ2xGLDRFQUE2RTtBQUM3RSwwRUFBMkU7QUFDM0UsaUNBQWtDO0FBRWxDLE9BQU8sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBRXhCLFdBQVcsQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7QUFFdkMsTUFBTSxnQkFBZ0IsR0FBRywyQkFBMkIsQ0FBQztBQUNyRCxNQUFNLFVBQVUsR0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLENBQUM7QUFDakYsTUFBTSxVQUFVLEdBQUcsRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQztBQUV4RCxRQUFRLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUM7QUFDN0MsUUFBUSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7QUFDbkQsUUFBUSxDQUFDLGNBQWMsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7QUFFbkQsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBRWhDLElBQUksQ0FBQyx3REFBd0QsRUFBRSxLQUFLLElBQUksRUFBRTtJQUN4RSxJQUFJLGVBQWUsR0FBRyxDQUFDLENBQUM7SUFFeEIsS0FBSyxDQUFDLGVBQWUsR0FBRyxLQUFLLEVBQUMsS0FBSyxFQUFDLEVBQUU7UUFDcEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUMsTUFB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QztBQUMvRCxDQUFDO0FBRUQsU0FBUyw0QkFBNEIsQ0FBQyxPQUFnRSxFQUFFO0lBQ3RHLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2xELE1BQU0sTUFBTSxHQUFJLEtBQUssQ0FBQyxXQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBZSxDQUFDLENBQUM7S0FDL0M7QUFDSCxDQUFDO0FBRUQsU0FBUyxjQUFjO0lBQ3JCLE1BQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbWF4LWxlbiAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0cyAqL1xuaW1wb3J0IGNmblJlc3BvbnNlID0gcmVxdWlyZSgnLi4vLi4vbGliL3Byb3ZpZGVyLWZyYW1ld29yay9ydW50aW1lL2Nmbi1yZXNwb25zZScpO1xuaW1wb3J0IGZyYW1ld29yayA9IHJlcXVpcmUoJy4uLy4uL2xpYi9wcm92aWRlci1mcmFtZXdvcmsvcnVudGltZS9mcmFtZXdvcmsnKTtcbmltcG9ydCBvdXRib3VuZCA9IHJlcXVpcmUoJy4uLy4uL2xpYi9wcm92aWRlci1mcmFtZXdvcmsvcnVudGltZS9vdXRib3VuZCcpO1xuaW1wb3J0IG1vY2tzID0gcmVxdWlyZSgnLi9tb2NrcycpO1xuXG5jb25zb2xlLmxvZyA9IGplc3QuZm4oKTtcblxuY2ZuUmVzcG9uc2UuaW5jbHVkZVN0YWNrVHJhY2VzID0gZmFsc2U7XG5cbmNvbnN0IE1PQ0tfUEhZU0lDQUxfSUQgPSAnbW9jay1waHlzaWNhbC1yZXNvdXJjZS1pZCc7XG5jb25zdCBNT0NLX1BST1BTID0geyBOYW1lOiAnVmFsdWUnLCBMaXN0OiBbJzEnLCAnMicsICczJ10sIFNlcnZpY2VUb2tlbjogJ2JsYScgfTtcbmNvbnN0IE1PQ0tfQVRUUlMgPSB7IE15QXR0cmlidXRlOiAnbXktbW9jay1hdHRyaWJ1dGUnIH07XG5cbm91dGJvdW5kLmh0dHBSZXF1ZXN0ID0gbW9ja3MuaHR0cFJlcXVlc3RNb2NrO1xub3V0Ym91bmQuaW52b2tlRnVuY3Rpb24gPSBtb2Nrcy5pbnZva2VGdW5jdGlvbk1vY2s7XG5vdXRib3VuZC5zdGFydEV4ZWN1dGlvbiA9IG1vY2tzLnN0YXJ0RXhlY3V0aW9uTW9jaztcblxuYmVmb3JlRWFjaCgoKSA9PiBtb2Nrcy5zZXR1cCgpKTtcblxudGVzdCgnYXN5bmMgZmxvdzogaXNDb21wbGV0ZSByZXR1cm5zIHRydWUgb25seSBhZnRlciAzIHRpbWVzJywgYXN5bmMgKCkgPT4ge1xuICBsZXQgaXNDb21wbGV0ZUNhbGxzID0gMDtcblxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyBldmVudCA9PiB7XG4gICAgZXhwZWN0KGV2ZW50LlJlcXVlc3RUeXBlKS50b0VxdWFsKCdDcmVhdGUnKTtcbiAgICBleHBlY3QoZXZlbnQuUmVzb3VyY2VQcm9wZXJ0aWVzKS50b1N0cmljdEVxdWFsKE1PQ0tfUFJPUFMpO1xuICAgIGV4cGVjdChldmVudC5QaHlzaWNhbFJlc291cmNlSWQpLnRvQmVVbmRlZmluZWQoKTsgLy8gcGh5c2ljYWwgSUQgaW4gQ1JFQVRFXG5cbiAgICByZXR1cm4ge1xuICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICAgICAgRGF0YTogTU9DS19BVFRSUyxcbiAgICAgIEFyYml0cmFyeUZpZWxkOiAxMjM0LFxuICAgIH07XG4gIH07XG5cbiAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgZXZlbnQgPT4ge1xuICAgIGlzQ29tcGxldGVDYWxscysrO1xuICAgIGV4cGVjdCgoZXZlbnQgYXMgYW55KS5BcmJpdHJhcnlGaWVsZCkudG9FcXVhbCgxMjM0KTsgLy8gYW55IGZpZWxkIGlzIHBhc3NlZCB0aHJvdWdoXG4gICAgZXhwZWN0KGV2ZW50LlBoeXNpY2FsUmVzb3VyY2VJZCkudG9FcXVhbChNT0NLX1BIWVNJQ0FMX0lEKTsgLy8gcGh5c2ljYWwgSUQgcmV0dXJuZWQgZnJvbSBvbkV2ZW50IGlzIHBhc3NlZCB0byBcImlzQ29tcGxldGVcIlxuICAgIGV4cGVjdChldmVudC5EYXRhKS50b1N0cmljdEVxdWFsKE1PQ0tfQVRUUlMpOyAvLyBhdHRyaWJ1dGVzIGFyZSBwcm9wYWdhdGVkIGJldHdlZW4gdGhlIGNhbGxzXG5cbiAgICBjb25zdCByZXN1bHQgPSBpc0NvbXBsZXRlQ2FsbHMgPT09IDM7XG4gICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIElzQ29tcGxldGU6IGZhbHNlLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgSXNDb21wbGV0ZTogdHJ1ZSxcbiAgICAgIERhdGE6IHtcbiAgICAgICAgQWRkaXRpb25hbDogJ2F0dHJpYnV0ZScsIC8vIGFkZGl0aW9uYWwgYXR0cmlidXRlcyBjYW4gYmUgcmV0dXJuZWQgZnJvbSBcImlzQ29tcGxldGVcIlxuICAgICAgfSxcbiAgICB9O1xuICB9O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICAgIFJlc291cmNlUHJvcGVydGllczogTU9DS19QUk9QUyxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoaXNDb21wbGV0ZUNhbGxzKS50b0VxdWFsKDMpO1xuXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2Vzcyh7XG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICAgIERhdGE6IHtcbiAgICAgIC4uLk1PQ0tfQVRUUlMsXG4gICAgICBBZGRpdGlvbmFsOiAnYXR0cmlidXRlJyxcbiAgICB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdpc0NvbXBsZXRlIHRocm93cyBpbiB0aGUgZmlyc3QgaW52b2NhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignU29tZSBmYWlsdXJlJyk7IH07XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiBNT0NLX1BST1BTLFxuICB9KTtcblxuICBleHBlY3RDbG91ZEZvcm1hdGlvbkZhaWxlZCgnU29tZSBmYWlsdXJlXFxuXFxuTG9nczogL2F3cy9sYW1iZGEvY29tcGxldGVcXG4nKTtcbn0pO1xuXG50ZXN0KCdmYWlscyBncmFjZWZ1bGx5IGlmIFwib25FdmVudFwiIHRocm93cyBhbiBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4geyB0aHJvdyBuZXcgRXJyb3IoJ2Vycm9yIHRocm93biBkdXJpbmcgb25FdmVudCcpOyB9O1xuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBJc0NvbXBsZXRlOiB0cnVlIH0pO1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdlcnJvciB0aHJvd24gZHVyaW5nIG9uRXZlbnRcXG5cXG5Mb2dzOiAvYXdzL2xhbWJkYS9ldmVudFxcbicpO1xuICBleHBlY3ROb1dhaXRlcigpO1xufSk7XG5cbmRlc2NyaWJlKCdQaHlzaWNhbFJlc291cmNlSWQnLCAoKSA9PiB7XG5cbiAgZGVzY3JpYmUoJ2lmIG5vdCBvbWl0dGVkIGZyb20gb25FdmVudCByZXN1bHQnLCAoKSA9PiB7XG5cbiAgICBpdCgnZGVmYXVsdHMgdG8gUmVxdWVzdElkIGZvciBDUkVBVEUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB1bmRlZmluZWQ7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBtb2Nrcy5NT0NLX1JFUVVFU1QuUmVxdWVzdElkLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGVmYXVsdHMgdG8gdGhlIGN1cnJlbnQgUGh5c2ljYWxSZXNvdXJjZUlkIGZvciBVUERBVEUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB1bmRlZmluZWQ7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3Moe1xuICAgICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdkZWZhdWx0cyB0byB0aGUgY3VycmVudCBQaHlzaWNhbFJlc291cmNlSWQgZm9yIERFTEVURScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHVuZGVmaW5lZDtcblxuICAgICAgLy8gVEhFTlxuICAgICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2Vzcyh7XG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdVUERBVEU6IGNhbiBjaGFuZ2UgdGhlIHBoeXNpY2FsIElEIGJ5IHJldHVybmluZyBhIG5ldyBJRCcsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnIH0pO1xuICAgIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IHRydWUgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdDdXJyZW50UGh5c2ljYWxJZCcsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdERUxFVEU6IGNhbm5vdCBjaGFuZ2UgdGhlIHBoeXNpY2FsIHJlc291cmNlIElEIGR1cmluZyBhIGRlbGV0ZScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnIH0pO1xuICAgIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IHRydWUgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdDdXJyZW50UGh5c2ljYWxJZCcsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0Tm9XYWl0ZXIoKTtcbiAgICBleHBlY3RDbG91ZEZvcm1hdGlvbkZhaWxlZCgnREVMRVRFOiBjYW5ub3QgY2hhbmdlIHRoZSBwaHlzaWNhbCByZXNvdXJjZSBJRCBmcm9tIFwiQ3VycmVudFBoeXNpY2FsSWRcIiB0byBcIk5ld1BoeXNpY2FsSWRcIiBkdXJpbmcgZGVsZXRpb24nKTtcbiAgfSk7XG5cbn0pO1xuXG50ZXN0KCdpc0NvbXBsZXRlIGFsd2F5cyByZXR1cm5zIFwiZmFsc2VcIiBhbmQgdGhlbiBhIHRpbWVvdXQgb2NjdXJzJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBEYXRhOiB7IEZvbzogMTIzIH0sIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCB9KTtcbiAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgSXNDb21wbGV0ZTogZmFsc2UgfSk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdPcGVyYXRpb24gdGltZWQgb3V0Jyk7XG59KTtcblxudGVzdCgnaXNDb21wbGV0ZTogXCJEYXRhXCIgaXMgbm90IGFsbG93ZWQgaWYgSW5Db21wbGV0ZSBpcyBcIkZhbHNlXCInLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IERhdGE6IHsgRm9vOiAxMjMgfSwgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBJc0NvbXBsZXRlOiBmYWxzZSwgRGF0YTogeyBGb286IDMzMzMgfSB9KTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gIH0pO1xuXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdcIkRhdGFcIiBpcyBub3QgYWxsb3dlZCBpZiBcIklzQ29tcGxldGVcIiBpcyBcIkZhbHNlXCInKTtcbn0pO1xuXG50ZXN0KCdpZiB0aGVyZSBpcyBubyB1c2VyLWRlZmluZWQgXCJpc0NvbXBsZXRlXCIsIHRoZSB3YWl0ZXIgd2lsbCBub3QgYmUgdHJpZ2dlcmVkIG9yIG5lZWRlZCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdE5vV2FpdGVyKCk7XG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2Vzcyh7IFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCB9KTtcbn0pO1xuXG50ZXN0KCdmYWlscyBpZiB1c2VyIGhhbmRsZXIgcmV0dXJucyBhIG5vbi1vYmplY3QgcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLnN0cmluZ2lmeVBheWxvYWQgPSBmYWxzZTtcbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gJ3N0cmluZycgYXMgYW55O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7IFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdyZXR1cm4gdmFsdWVzIGZyb20gdXNlci1oYW5kbGVycyBtdXN0IGJlIEpTT04gb2JqZWN0cy4gZ290OiBcXFwic3RyaW5nXFxcIicpO1xufSk7XG5cbmRlc2NyaWJlKCdpZiBDUkVBVEUgZmFpbHMsIHRoZSBzdWJzZXF1ZW50IERFTEVURSB3aWxsIGJlIGlnbm9yZWQnLCAoKSA9PiB7XG5cbiAgaXQoJ0ZBSUxFRCByZXNwb25zZSBzZXRzIFBoeXNpY2FsUmVzb3VyY2VJZCB0byBhIHNwZWNpYWwgbWFya2VyJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignQ1JFQVRFIEZBSUxFRCcpOyB9O1xuXG4gICAgLy8gVEhFTlxuICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICAgIH0pO1xuXG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ0NSRUFURSBGQUlMRURcXG5cXG5Mb2dzOiAvYXdzL2xhbWJkYS9ldmVudFxcbicsIHtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogY2ZuUmVzcG9uc2UuQ1JFQVRFX0ZBSUxFRF9QSFlTSUNBTF9JRF9NQVJLRVIsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdERUxFVEUgcmVxdWVzdCB3aXRoIHRoZSBtYXJrZXIgc3VjY2VlZHMgd2l0aG91dCBjYWxsaW5nIHVzZXIgaGFuZGxlcicsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIC8vIHVzZXIgaGFuZGxlciBpcyBub3QgYXNzaWduZWRcblxuICAgIC8vIFdIRU5cbiAgICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogY2ZuUmVzcG9uc2UuQ1JFQVRFX0ZBSUxFRF9QSFlTSUNBTF9JRF9NQVJLRVIsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKCk7XG4gIH0pO1xuXG59KTtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBUcmlnZ2VycyB0aGUgY3VzdG9tIHJlc291cmNlIGxpZmVjeWNsZSBldmVudCBmbG93IGJ5IGludm9raW5nIHRoZSBmcmFtZXdvcmsnc1xuICogb25FdmVudCBmdW5jdGlvbiBhbmQgdGhlbiwgaWYgdGhlIHdhaXRlciBzdGF0ZSBtYWNoaW5lIHdhcyBzdGFydGVkLCBzaW11bGF0ZXNcbiAqIHRoZSB3YWl0ZXIgYW5kIGludm9rZXMgaXNDb21wbGV0ZSBhbmQgb25UaW1lb3V0IGFzIGFwcHJvcHJpYXRlLlxuICovXG5hc3luYyBmdW5jdGlvbiBzaW11bGF0ZUV2ZW50KHJlcTogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50Pikge1xuICBjb25zdCB4ID0ge1xuICAgIFNlcnZpY2VUb2tlbjogJ1NFUlZJQ0UtVE9LRU4nLFxuICAgIFJlc3BvbnNlVVJMOiBtb2Nrcy5NT0NLX1JFUVVFU1QuUmVzcG9uc2VVUkwsXG4gICAgU3RhY2tJZDogbW9ja3MuTU9DS19SRVFVRVNULlN0YWNrSWQsXG4gICAgUmVxdWVzdElkOiBtb2Nrcy5NT0NLX1JFUVVFU1QuUmVxdWVzdElkLFxuICAgIFJlc291cmNlVHlwZTogJ0N1c3RvbTo6VGVzdFJlc291cmNlJyxcbiAgICBMb2dpY2FsUmVzb3VyY2VJZDogbW9ja3MuTU9DS19SRVFVRVNULkxvZ2ljYWxSZXNvdXJjZUlkLFxuICAgIC4uLnJlcSxcbiAgfTtcblxuICBtb2Nrcy5wcmVwYXJlRm9yRXhlY3V0aW9uKCk7XG5cbiAgYXdhaXQgZnJhbWV3b3JrLm9uRXZlbnQoeCBhcyBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUV2ZW50KTtcblxuICAvLyBpZiB0aGUgRlNNXG4gIGlmIChtb2Nrcy5zdGFydFN0YXRlTWFjaGluZUlucHV0ICYmIG1vY2tzLnN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQuc3RhdGVNYWNoaW5lQXJuID09PSBtb2Nrcy5NT0NLX1NGTl9BUk4pIHtcbiAgICBhd2FpdCBzaW11bGF0ZVdhaXRlcihKU09OLnBhcnNlKG1vY2tzLnN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQuaW5wdXQhKSk7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBzaW11bGF0ZVdhaXRlcihldmVudDogQVdTQ0RLQXN5bmNDdXN0b21SZXNvdXJjZS5Jc0NvbXBsZXRlUmVxdWVzdCkge1xuICAgIGxldCByZXRyeSA9IHRydWU7XG4gICAgbGV0IGNvdW50ID0gNTtcbiAgICB3aGlsZSAocmV0cnkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZyYW1ld29yay5pc0NvbXBsZXRlKGV2ZW50KTtcbiAgICAgICAgcmV0cnkgPSBmYWxzZTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBjZm5SZXNwb25zZS5SZXRyeSkge1xuICAgICAgICAgIGlmIChjb3VudC0tID09PSAwKSB7XG4gICAgICAgICAgICBhd2FpdCBmcmFtZXdvcmsub25UaW1lb3V0KHsgQ2F1c2U6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3JNZXNzYWdlOiBlLm1lc3NhZ2UgfSkgfSk7XG4gICAgICAgICAgICByZXRyeSA9IGZhbHNlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXRyeSA9IHRydWU7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKGV4cGVjdGVkUmVhc29uOiBzdHJpbmcsIHJlc3A/OiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlUmVzcG9uc2U+KSB7XG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uUmVzcG9uc2Uoe1xuICAgIFN0YXR1czogJ0ZBSUxFRCcsXG4gICAgUmVhc29uOiBleHBlY3RlZFJlYXNvbixcbiAgICAuLi5yZXNwLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHJlc3A/OiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlUmVzcG9uc2U+KSB7XG4gIGlmIChtb2Nrcy5jZm5SZXNwb25zZS5TdGF0dXMgIT09ICdTVUNDRVNTJykge1xuICAgIGNvbnNvbGUuZXJyb3IobW9ja3MuY2ZuUmVzcG9uc2UuUmVhc29uIHx8ICc8Tk8gUkVBU09OPicpO1xuICB9XG5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25SZXNwb25zZSh7IFN0YXR1czogJ1NVQ0NFU1MnLCAuLi5yZXNwIH0pO1xufVxuXG5mdW5jdGlvbiBleHBlY3RDbG91ZEZvcm1hdGlvblJlc3BvbnNlKHJlc3A6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VSZXNwb25zZT4gPSB7fSkge1xuICBmb3IgKGNvbnN0IFtrZXksIGV4cGVjdGVkXSBvZiBPYmplY3QuZW50cmllcyhyZXNwKSkge1xuICAgIGNvbnN0IGFjdHVhbCA9IChtb2Nrcy5jZm5SZXNwb25zZSBhcyBhbnkpW2tleV07XG4gICAgZXhwZWN0KGFjdHVhbCkudG9TdHJpY3RFcXVhbChleHBlY3RlZCBhcyBhbnkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGV4cGVjdE5vV2FpdGVyKCkge1xuICBleHBlY3QobW9ja3Muc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dCkudG9CZVVuZGVmaW5lZCgpO1xufVxuIl19